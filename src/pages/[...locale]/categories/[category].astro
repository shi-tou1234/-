---
import MainPageLayout from '@layouts/MainPageLayout.astro'
import Cover from '@components/Cover.astro'

import { siteConfig } from '@/config'
import { getBlogEntrySort } from '@utils/content-utils'
import i18nit from '@i18n/translation'

import { i18n } from "astro:config/client";
import { getRelativeLocaleUrl } from '@utils/url-utils';

const currentLang = Astro.currentLocale || i18n!.defaultLocale;
const t = i18nit(currentLang);

const uncategorized = currentLang === 'zh-cn' ? '未分类' : 'Uncategorized';
const CATEGORY_PARAM_PREFIX = 'b64-';

function decodeCategoryParam(categoryParam: string): string {
  if (!categoryParam) return '';

  if (categoryParam.startsWith(CATEGORY_PARAM_PREFIX)) {
    const encoded = categoryParam.slice(CATEGORY_PARAM_PREFIX.length);
    if (encoded) {
      try {
        return Buffer.from(encoded, 'base64url').toString('utf-8');
      } catch {
      }
    }
  }

  try {
    return decodeURIComponent(categoryParam);
  } catch {
    return categoryParam;
  }
}

function getPostCategories(post: any): string[] {
  const legacyCategories = Array.isArray(post.data.categories)
    ? post.data.categories.map((item) => String(item).trim()).filter(Boolean)
    : [];
  const singleCategory = String(post.data.category || '').trim();
  const merged = [...legacyCategories, ...(singleCategory ? [singleCategory] : [])];
  const unique = [...new Set(merged)];
  return unique.length > 0 ? unique : [uncategorized];
}

export async function getStaticPaths() {
  const locales = i18n?.locales || [i18n?.defaultLocale];
  const paths = [];

  for (const locale of locales) {
    const localeCode = typeof locale === 'string' ? locale : locale.path;
    const localeParam = localeCode === i18n?.defaultLocale ? undefined : localeCode;
    const posts = await getBlogEntrySort(localeCode);
    const localeUncategorized = localeCode === 'zh-cn' ? '未分类' : 'Uncategorized';

    const getLocalePostCategories = (post: (typeof posts)[number]): string[] => {
      const legacyCategories = Array.isArray(post.data.categories)
        ? post.data.categories.map((item) => String(item).trim()).filter(Boolean)
        : [];
      const singleCategory = String(post.data.category || '').trim();
      const merged = [...legacyCategories, ...(singleCategory ? [singleCategory] : [])];
      const unique = [...new Set(merged)];
      return unique.length > 0 ? unique : [localeUncategorized];
    };

    const categorySet = new Set<string>();
    posts.filter((post) => post.id !== 'welcome').forEach((post) => {
      getLocalePostCategories(post).forEach((category) => categorySet.add(category));
    });

    categorySet.forEach((categoryName) => {
      paths.push({
        params: {
          locale: localeParam,
          category: `b64-${Buffer.from(categoryName, 'utf-8').toString('base64url')}`
        }
      });
    });
  }

  return paths;
}

const currentCategoryParam = Astro.params.category || '';
const currentCategory = decodeCategoryParam(currentCategoryParam);

const allBlogPosts = await getBlogEntrySort(currentLang);
const categoryPosts = allBlogPosts
  .filter((post) => post.id !== 'welcome')
  .filter((post) => getPostCategories(post).includes(currentCategory));

const pageTitle = `${currentCategory} - ${t("header.categories")} - ${siteConfig.title}`;
const categoriesRoot = getRelativeLocaleUrl(currentLang, '/categories/');
---

<MainPageLayout title={pageTitle} lang={currentLang}>
  <div id="category-detail-particles" class="pointer-events-none fixed inset-0 z-0"></div>
  <div class="relative z-10 mx-auto w-full max-w-[var(--page-width)]">
    <Cover title={currentCategory} subTitle={t("cover.subTitle.archive", {count: categoryPosts.length})} />

    <div class="py-6 text-[var(--text-color)] space-y-2">
      <a href={categoriesRoot} class="group inline-flex items-center gap-1.5 mb-4 rounded-full border border-[var(--button-border-color)] px-3 py-1.5 text-sm transition-all duration-200 hover:border-[var(--link-color)] hover:bg-[var(--button-hover-color)] hover:text-[var(--link-color)] active:scale-95">
        <span class="inline-block transition-transform duration-200 group-hover:-translate-x-0.5">←</span>
        <span>{t("header.categories")}</span>
      </a>

      {categoryPosts.map((post) => (
        <a href={getRelativeLocaleUrl(currentLang, `/blog/${post.id}`)}
          class="group block rounded p-2 hover:bg-[var(--button-hover-color)] active:bg-[var(--button-hover-color)] transition-colors duration-200">
          <span class="text-lg transition-all duration-200 group-hover:pl-2 group-hover:text-[var(--link-color)] group-hover:font-bold">{post.data.title}</span>
          {
            post.isFallback && (
              <span class="self-center px-1 ml-2 text-sm text-[var(--text-color)]/70 font-mono uppercase bg-[var(--button-hover-color)] rounded border border-[var(--button-border-color)]">{i18n!.defaultLocale}</span>
            )
          }
        </a>
      ))}
    </div>
  </div>
</MainPageLayout>

<script>
  import { tsParticles } from "@tsparticles/engine";
  import { loadSlim } from "@tsparticles/slim";

  const containerId = "category-detail-particles";

  function isActivePage() {
    return Boolean(document.getElementById(containerId));
  }

  function getParticleColor() {
    const computed = getComputedStyle(document.documentElement);
    const linkColor = computed.getPropertyValue("--link-color").trim();
    if (linkColor) return linkColor;
    const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
    return currentTheme === "dark" ? "#93c5fd" : "#1d4ed8";
  }

  async function mountParticles() {
    if (!isActivePage()) return;

    await loadSlim(tsParticles);

    const mounted = tsParticles.dom().find((item) => item.id === containerId);
    if (mounted) {
      await mounted.destroy();
    }

    const color = getParticleColor();

    await tsParticles.load({
      id: containerId,
      options: {
        fullScreen: { enable: false },
        background: { color: "transparent" },
        fpsLimit: 60,
        detectRetina: true,
        particles: {
          number: { value: 90, density: { enable: true, area: 1000 } },
          color: { value: color },
          opacity: { value: { min: 0.14, max: 0.45 } },
          size: { value: { min: 1, max: 2.6 } },
          move: {
            enable: true,
            speed: 1.8,
            direction: "none",
            random: true,
            straight: false,
            outModes: { default: "bounce" },
          },
          links: {
            enable: false,
          },
        },
        interactivity: {
          detectsOn: "canvas",
          events: {
            onHover: { enable: true, mode: ["repulse"] },
            onClick: { enable: true, mode: "repulse" },
            resize: { enable: true },
          },
          modes: {
            repulse: { distance: 90, duration: 0.45 },
          },
        },
        pauseOnBlur: false,
        pauseOnOutsideViewport: false,
      },
    });
  }

  function setupThemeWatcher() {
    if (!isActivePage()) return;

    const oldObserver = window.__categoryDetailParticleThemeObserver;
    if (oldObserver) oldObserver.disconnect();

    const observer = new MutationObserver(() => {
      mountParticles();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });

    window.__categoryDetailParticleThemeObserver = observer;
  }

  function initEnhancements() {
    if (!isActivePage()) return;
    mountParticles();
    setupThemeWatcher();
  }

  initEnhancements();
  document.addEventListener("astro:page-load", initEnhancements);
  document.addEventListener("astro:after-swap", initEnhancements);
</script>
