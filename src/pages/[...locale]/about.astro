---
import MainPageLayout from '@layouts/MainPageLayout.astro'
import Markdown from '@components/misc/Markdown.astro'
import Cover from '@components/Cover.astro'

import { getBlogEntrySort, getSpec } from '@utils/content-utils'
import aboutProfile from '@/data/about-profile'

import { siteConfig } from '@/config'
import i18nit from '@i18n/translation'
import { render } from 'astro:content'
import { execSync } from 'node:child_process'
import { i18n } from "astro:config/client";

export async function getStaticPaths() {
	return i18n?.locales.map(locale => ({ params: { locale: locale == i18n?.defaultLocale ? undefined : (locale as string) } }));
}


const currentLang = Astro.currentLocale || i18n!.defaultLocale;
const t = i18nit(currentLang);

const aboutPost = await getSpec(currentLang, 'about');
if (!aboutPost) {
    throw new Error('No about post found');
}
const { Content } = await render(aboutPost);

const HEATMAP_DAYS = 140;
const today = new Date();
today.setHours(0, 0, 0, 0);

const startDate = new Date(today);
startDate.setDate(today.getDate() - HEATMAP_DAYS + 1);

const blogUpdateCountMap = new Map<string, number>();
const codeUpdateCountMap = new Map<string, number>();
const blogEntries = await getBlogEntrySort(currentLang);

for (const entry of blogEntries) {
    const date = new Date(entry.data.pubDate);
    date.setHours(0, 0, 0, 0);
    if (date < startDate || date > today) continue;
    const key = date.toISOString().slice(0, 10);
        blogUpdateCountMap.set(key, (blogUpdateCountMap.get(key) || 0) + 1);
}

try {
        const since = startDate.toISOString().slice(0, 10);
        const until = today.toISOString().slice(0, 10);
        const output = execSync(
                `git log --since="${since}" --until="${until} 23:59:59" --date=short --pretty=format:%ad -- src public script astro.config.mjs svelte.config.js tsconfig.json package.json pnpm-lock.yaml`,
                { encoding: 'utf-8' }
        );

        for (const rawLine of output.split('\n')) {
                const key = rawLine.trim();
                if (!key) continue;
                codeUpdateCountMap.set(key, (codeUpdateCountMap.get(key) || 0) + 1);
        }
} catch {
}

if (codeUpdateCountMap.size === 0) {
        try {
                const sinceIso = startDate.toISOString();
                const untilDateTime = new Date(today);
                untilDateTime.setHours(23, 59, 59, 999);
                const untilIso = untilDateTime.toISOString();

                for (let page = 1; page <= 5; page += 1) {
                        const url = `https://api.github.com/repos/shi-tou1234/-/commits?since=${encodeURIComponent(sinceIso)}&until=${encodeURIComponent(untilIso)}&per_page=100&page=${page}`;
                        const response = await fetch(url, {
                                headers: {
                                        Accept: 'application/vnd.github+json',
                                },
                        });
                        if (!response.ok) break;

                        const commits = await response.json();
                        if (!Array.isArray(commits) || commits.length === 0) break;

                        for (const commit of commits) {
                                const dateString = commit?.commit?.author?.date || commit?.commit?.committer?.date;
                                if (!dateString) continue;
                                const date = new Date(dateString);
                                date.setHours(0, 0, 0, 0);
                                if (date < startDate || date > today) continue;
                                const key = date.toISOString().slice(0, 10);
                                codeUpdateCountMap.set(key, (codeUpdateCountMap.get(key) || 0) + 1);
                        }

                        if (commits.length < 100) break;
                }
        } catch {
        }
}

const daySeries = [] as Array<{ key: string; date: Date; blogCount: number; codeCount: number }>;
for (let index = 0; index < HEATMAP_DAYS; index += 1) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + index);
    const key = date.toISOString().slice(0, 10);
        daySeries.push({
                key,
                date,
                blogCount: blogUpdateCountMap.get(key) || 0,
                codeCount: codeUpdateCountMap.get(key) || 0,
        });
}

const totalBlogUpdates = daySeries.reduce((sum, item) => sum + item.blogCount, 0);
const totalCodeUpdates = daySeries.reduce((sum, item) => sum + item.codeCount, 0);
const maxBlogCount = Math.max(...daySeries.map((item) => item.blogCount), 1);
const maxCodeCount = Math.max(...daySeries.map((item) => item.codeCount), 1);
const leadingPadCount = startDate.getDay();

const heatmapCells = [
        ...Array.from({ length: leadingPadCount }, () => null),
        ...daySeries,
] as Array<{ key: string; date: Date; blogCount: number; codeCount: number } | null>;

const heatmapWeeks = [] as Array<Array<{ key: string; date: Date; blogCount: number; codeCount: number } | null>>;
for (let index = 0; index < heatmapCells.length; index += 7) {
    const week = heatmapCells.slice(index, index + 7);
    while (week.length < 7) week.push(null);
    heatmapWeeks.push(week);
}

const weekdayLabels = currentLang === 'zh-cn'
    ? ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']
    : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

const profileLabels = currentLang === 'zh-cn'
    ? {
            traitTitle: 'å…³äºŽæˆ‘çš„ç‰¹è´¨',
            mbti: 'MBTI',
            major: 'æ‰€å­¦ä¸“ä¸š',
                        mbtiIntro: 'æŸ¥çœ‹ MBTI ä»‹ç»',
                        majorIntro: 'æŸ¥çœ‹ä¸“ä¸šç™¾ç§‘',
            recentDoing: 'æœ€è¿‘åœ¨åš',
            recentReading: 'æœ€è¿‘è¯»ä¹¦',
                        heatmapTitle: 'åšå®¢ä¸Žç½‘ç«™ä»£ç æ›´æ–°é¢‘çŽ‡',
                        heatmapSubtitle: `è¿‡åŽ» ${HEATMAP_DAYS} å¤© Â· åšå®¢ ${totalBlogUpdates} æ¬¡ Â· ä»£ç  ${totalCodeUpdates} æ¬¡`,
                        heatmapBlog: 'åšå®¢',
                        heatmapCode: 'ä»£ç ',
            legendLow: 'ä½Ž',
            legendHigh: 'é«˜',
            noUpdate: 'æš‚æ— æ›´æ–°',
        }
    : {
            traitTitle: 'My Traits',
            mbti: 'MBTI',
            major: 'Major',
                        mbtiIntro: 'View MBTI intro',
                        majorIntro: 'View major wiki',
            recentDoing: 'Recent Focus',
            recentReading: 'Recent Reading',
                        heatmapTitle: 'Blog & Site Code Activity',
                        heatmapSubtitle: `Last ${HEATMAP_DAYS} days Â· Blog ${totalBlogUpdates} Â· Code ${totalCodeUpdates}`,
                        heatmapBlog: 'Blog',
                        heatmapCode: 'Code',
            legendLow: 'Low',
            legendHigh: 'High',
            noUpdate: 'No updates',
        };

function getIntensityLevel(count: number, maxCount: number): number {
    if (count <= 0) return 0;
    const ratio = count / maxCount;
    if (ratio < 0.25) return 1;
    if (ratio < 0.5) return 2;
    if (ratio < 0.75) return 3;
    return 4;
}

const pageTitle = t("header.about") + " - " + siteConfig.title;
---
<MainPageLayout title={pageTitle} lang={currentLang}>
        <div class="relative z-10 mx-auto w-full max-w-[var(--page-width)]">

                <Cover title={t("cover.title.about")} subTitle={t("cover.subTitle.about")}/>

                <section class="mb-6 rounded-xl border border-[var(--button-border-color)] bg-[var(--postcard-bg-color)]/40 p-4 md:p-5">
                        <Markdown class="markdown-content onload-animation">
                                <Content />
                        </Markdown>

                        <div class="mt-5 border-t border-[var(--button-border-color)]/70 pt-4">
                                <h2 class="mb-4 text-lg font-semibold text-[var(--text-color)]">{profileLabels.traitTitle}</h2>
                                <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
                                        <div class="rounded-lg border border-[var(--button-border-color)] bg-[var(--bg-color)]/50 px-4 py-3">
                                                <p class="text-xs text-[var(--text-color)]/60">{profileLabels.mbti}</p>
                                                <a
                                                        href={aboutProfile.mbtiLink}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        class="mt-1 flex items-center gap-2 text-base font-semibold text-[var(--link-color)] hover:underline"
                                                >
                                                        <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--button-hover-color)] text-[13px]">ðŸ§ </span>
                                                        <span>{aboutProfile.mbti}</span>
                                                        <span class="text-xs text-[var(--text-color)]/60">({profileLabels.mbtiIntro})</span>
                                                </a>
                                        </div>
                                        <div class="rounded-lg border border-[var(--button-border-color)] bg-[var(--bg-color)]/50 px-4 py-3">
                                                <p class="text-xs text-[var(--text-color)]/60">{profileLabels.major}</p>
                                                <a
                                                        href={aboutProfile.majorLink}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        class="mt-1 flex items-center gap-2 text-base font-semibold text-[var(--link-color)] hover:underline"
                                                >
                                                        <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--button-hover-color)] text-[13px]">ðŸŽ“</span>
                                                        <span>{aboutProfile.major}</span>
                                                        <span class="text-xs text-[var(--text-color)]/60">({profileLabels.majorIntro})</span>
                                                </a>
                                        </div>
                                        <div class="rounded-lg border border-[var(--button-border-color)] bg-[var(--bg-color)]/50 px-4 py-3 md:col-span-2">
                                                <p class="text-xs text-[var(--text-color)]/60">{profileLabels.recentDoing}</p>
                                                <p class="mt-1 text-base font-semibold text-[var(--text-color)]">{aboutProfile.recentDoing}</p>
                                        </div>
                                        <div class="rounded-lg border border-[var(--button-border-color)] bg-[var(--bg-color)]/50 px-4 py-3 md:col-span-2">
                                                <p class="text-xs text-[var(--text-color)]/60">{profileLabels.recentReading}</p>
                                                <p class="mt-1 text-base font-semibold text-[var(--text-color)]">{aboutProfile.recentReading}</p>
                                        </div>
                                </div>
                        </div>
                </section>

                <section class="mb-8 rounded-xl border border-[var(--button-border-color)] bg-[var(--postcard-bg-color)]/40 p-4 md:p-5">
                        <div class="mb-4 flex flex-wrap items-end justify-between gap-2">
                                <div>
                                        <h2 class="text-lg font-semibold text-[var(--text-color)]">{profileLabels.heatmapTitle}</h2>
                                        <p
                                                id="about-heatmap-subtitle"
                                                data-days={HEATMAP_DAYS}
                                                data-blog-total={totalBlogUpdates}
                                                data-code-total={totalCodeUpdates}
                                                data-blog-label={profileLabels.heatmapBlog}
                                                data-code-label={profileLabels.heatmapCode}
                                                data-lang={currentLang}
                                                class="text-sm text-[var(--text-color)]/65"
                                        >{profileLabels.heatmapSubtitle}</p>
                                        <p class="mt-1 flex items-center gap-3 text-xs text-[var(--text-color)]/60">
                                                <span>{profileLabels.heatmapBlog}: {totalBlogUpdates}</span>
                                                <span id="about-code-total" data-label={profileLabels.heatmapCode} data-value={totalCodeUpdates}>{profileLabels.heatmapCode}: {totalCodeUpdates}</span>
                                        </p>
                                </div>
                                <div class="flex items-center gap-2 text-xs text-[var(--text-color)]/65">
                                        <span>{profileLabels.legendLow}</span>
                                        {[0, 1, 2, 3, 4].map((level) => (
                                                <span
                                                        class="h-3.5 w-3.5 rounded-sm border border-[var(--button-border-color)]"
                                                        style={level === 0
                                                                ? 'background: var(--button-hover-color);'
                                                                : `background: color-mix(in srgb, var(--link-color) ${20 + level * 18}%, var(--button-hover-color));`}
                                                ></span>
                                        ))}
                                        <span>{profileLabels.legendHigh}</span>
                                </div>
                        </div>

                        <div class="about-heatmap-wrap overflow-x-auto">
                                <div class="inline-flex gap-2 min-w-full">
                                        <div class="grid grid-rows-7 gap-1 pt-5 text-[10px] text-[var(--text-color)]/55">
                                                {weekdayLabels.map((label, index) => (
                                                        <span class={`flex h-10 items-center ${index % 2 === 0 ? '' : 'opacity-0'}`}>{label}</span>
                                                ))}
                                        </div>

                                        <div class="flex gap-1">
                                                {heatmapWeeks.map((week) => (
                                                        <div class="grid grid-rows-7 gap-1">
                                                                {week.map((cell) => (
                                                                        cell ? (
                                                                                <div class="flex h-10 w-6 flex-col gap-[2px]">
                                                                                        <span
                                                                                                title={`${cell.key} Â· ${profileLabels.heatmapBlog}: ${cell.blogCount}`}
                                                                                                class="h-[19px] w-6 rounded-sm border border-[var(--button-border-color)]"
                                                                                                style={(() => {
                                                                                                        const level = getIntensityLevel(cell.blogCount, maxBlogCount);
                                                                                                        return level === 0
                                                                                                            ? 'background: var(--button-hover-color);'
                                                                                                            : `background: color-mix(in srgb, var(--link-color) ${20 + level * 18}%, var(--button-hover-color));`;
                                                                                                })()}
                                                                                        ></span>
                                                                                        <span
                                                                                                title={`${cell.key} Â· ${profileLabels.heatmapCode}: ${cell.codeCount}`}
                                                                                                data-code-cell="1"
                                                                                                data-date={cell.key}
                                                                                                class="h-[19px] w-6 rounded-sm border border-[var(--button-border-color)]"
                                                                                                style={(() => {
                                                                                                        const level = getIntensityLevel(cell.codeCount, maxCodeCount);
                                                                                                        return level === 0
                                                                                                            ? 'background: var(--button-hover-color);'
                                                                                                            : `background: color-mix(in srgb, var(--link-color) ${20 + level * 18}%, var(--button-hover-color));`;
                                                                                                })()}
                                                                                        ></span>
                                                                                </div>
                                                                        ) : (
                                                                                <span class="h-10 w-6 rounded-sm bg-transparent"></span>
                                                                        )
                                                                ))}
                                                        </div>
                                                ))}
                                        </div>
                                </div>
                        </div>

                        <div class="mt-3 flex items-center gap-4 text-xs text-[var(--text-color)]/65">
                                <span class="font-medium">{profileLabels.heatmapBlog}</span>
                                <span class="font-medium">{profileLabels.heatmapCode}</span>
                        </div>

                        {totalBlogUpdates + totalCodeUpdates === 0 && (
                                <p class="mt-3 text-sm text-[var(--text-color)]/65">{profileLabels.noUpdate}</p>
                        )}
                </section>
    </div>
</MainPageLayout>

<script>
        function initEnhancements() {
                if (!document.getElementById('about-heatmap-subtitle')) return;
                renderHeatmapSubtitle();
                refreshCodeHeatmapFromGithub();
        }

        function renderHeatmapSubtitle() {
                const subtitleEl = document.getElementById('about-heatmap-subtitle');
                if (!subtitleEl) return;
                const days = Number(subtitleEl.getAttribute('data-days') || '140');
                const blogTotal = Number(subtitleEl.getAttribute('data-blog-total') || '0');
                const codeTotal = Number(subtitleEl.getAttribute('data-code-total') || '0');
                const blogLabel = subtitleEl.getAttribute('data-blog-label') || 'Blog';
                const codeLabel = subtitleEl.getAttribute('data-code-label') || 'Code';
                const lang = subtitleEl.getAttribute('data-lang') || 'en';

                subtitleEl.textContent = lang === 'zh-cn'
                        ? `è¿‡åŽ» ${days} å¤© Â· ${blogLabel} ${blogTotal} æ¬¡ Â· ${codeLabel} ${codeTotal} æ¬¡`
                        : `Last ${days} days Â· ${blogLabel} ${blogTotal} Â· ${codeLabel} ${codeTotal}`;
        }

        function getCodeCellStyle(level) {
                if (level <= 0) return 'background: var(--button-hover-color);';
                return `background: color-mix(in srgb, var(--link-color) ${20 + level * 18}%, var(--button-hover-color));`;
        }

        function getIntensityLevel(count, maxCount) {
                if (count <= 0) return 0;
                const ratio = count / Math.max(maxCount, 1);
                if (ratio < 0.25) return 1;
                if (ratio < 0.5) return 2;
                if (ratio < 0.75) return 3;
                return 4;
        }

        async function refreshCodeHeatmapFromGithub() {
                const codeCells = Array.from(document.querySelectorAll('[data-code-cell="1"][data-date]'));
                if (codeCells.length === 0) return;

                const dates = codeCells.map((cell) => cell.getAttribute('data-date')).filter(Boolean).sort();
                if (dates.length === 0) return;

                const since = `${dates[0]}T00:00:00.000Z`;
                const until = `${dates[dates.length - 1]}T23:59:59.999Z`;
                const countMap = new Map();

                try {
                        for (let page = 1; page <= 5; page += 1) {
                                const url = `https://api.github.com/repos/shi-tou1234/-/commits?sha=main&since=${encodeURIComponent(since)}&until=${encodeURIComponent(until)}&per_page=100&page=${page}`;
                                const response = await fetch(url, { headers: { Accept: 'application/vnd.github+json' } });
                                if (!response.ok) break;
                                const commits = await response.json();
                                if (!Array.isArray(commits) || commits.length === 0) break;

                                for (const commit of commits) {
                                        const dateString = commit?.commit?.author?.date || commit?.commit?.committer?.date;
                                        if (!dateString) continue;
                                        const key = new Date(dateString).toISOString().slice(0, 10);
                                        countMap.set(key, (countMap.get(key) || 0) + 1);
                                }

                                if (commits.length < 100) break;
                        }

                        let maxCodeCount = 1;
                        let totalCodeUpdates = 0;
                        for (const value of countMap.values()) {
                                maxCodeCount = Math.max(maxCodeCount, value);
                                totalCodeUpdates += value;
                        }

                        codeCells.forEach((cell) => {
                                const key = cell.getAttribute('data-date');
                                if (!key) return;
                                const count = countMap.get(key) || 0;
                                const level = getIntensityLevel(count, maxCodeCount);
                                cell.setAttribute('style', getCodeCellStyle(level));
                                const label = document.getElementById('about-code-total')?.getAttribute('data-label') || 'Code';
                                cell.setAttribute('title', `${key} Â· ${label}: ${count}`);
                        });

                        const totalEl = document.getElementById('about-code-total');
                        if (totalEl) {
                                const label = totalEl.getAttribute('data-label') || 'Code';
                                totalEl.textContent = `${label}: ${totalCodeUpdates}`;
                                totalEl.setAttribute('data-value', String(totalCodeUpdates));
                        }

                        const subtitleEl = document.getElementById('about-heatmap-subtitle');
                        if (subtitleEl) {
                                subtitleEl.setAttribute('data-code-total', String(totalCodeUpdates));
                                renderHeatmapSubtitle();
                        }
                } catch {
                }
        }

        initEnhancements();
        document.addEventListener("astro:page-load", initEnhancements);
        document.addEventListener("astro:after-swap", initEnhancements);
</script>