---
import MainPageLayout from '@layouts/MainPageLayout.astro'
import { siteConfig, friendLinkConfig } from '@/config'
import Cover from '@components/Cover.astro';

import i18nit from '@i18n/translation';

import { i18n } from "astro:config/client";

export async function getStaticPaths() {
	return i18n?.locales.map(locale => ({ params: { locale: locale == i18n?.defaultLocale ? undefined : (locale as string) } }));
}

const currentLang = Astro.currentLocale || i18n!.defaultLocale;
const t = i18nit(currentLang);

const pageTitle = t("header.friends") + " - " + siteConfig.title;
---

<MainPageLayout title={pageTitle} lang={currentLang}>
    <div id="friends-particles" class="pointer-events-none fixed inset-0 -z-10"></div>
    <div class="relative z-10 mx-auto w-full max-w-[var(--page-width)]">
        <Cover title={t("cover.title.friends")} subTitle={t("cover.subTitle.friends")} />
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-[var(--text-color)]">
            {
                friendLinkConfig.map((friend) => (
                    <a 
                        href={friend.url} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="flex items-center p-4 border border-[var(--button-border-color)] rounded-lg shadow-sm active:bg-[var(--button-hover-color)] hover:bg-[var(--button-hover-color)] transition-all duration-300 hover:scale-105"
                    >
                        <img 
                            src={friend.avatar} 
                            alt={friend.name} 
                            class="w-16 h-16 rounded-full object-cover mr-4"
                            onerror="this.src='https://www.gravatar.com/avatar/?d=mp'"
                        />
                        <div class="flex-1 min-w-0">
                            <h2 class="font-bold text-lg truncate">{friend.name}</h2>
                            <p class="text-[var(--text-color)]/60 text-sm">{friend.description}</p>
                        </div>
                    </a>
                ))
            }
        </div>
        
    </div>
</MainPageLayout>

<script>
    import { tsParticles } from "@tsparticles/engine";
    import { loadSlim } from "@tsparticles/slim";

    const containerId = "friends-particles";

    function isActivePage() {
        return Boolean(document.getElementById(containerId));
    }

    function getParticleColor() {
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        return currentTheme === "dark" ? "#ffffff" : "#0284c7";
    }

    async function mountParticles() {
        if (!isActivePage()) return;

        await loadSlim(tsParticles);

        const mounted = tsParticles.dom().find((item) => item.id === containerId);
        if (mounted) {
            await mounted.destroy();
        }

        const color = getParticleColor();

        await tsParticles.load({
            id: containerId,
            options: {
                fullScreen: { enable: true, zIndex: -1 },
                background: { color: "transparent" },
                fpsLimit: 60,
                detectRetina: true,
                particles: {
                    number: { value: 160, density: { enable: true, area: 700 } },
                    color: { value: color },
                    opacity: { value: { min: 0.35, max: 0.95 } },
                    size: { value: { min: 1.2, max: 3.8 } },
                    move: {
                        enable: true,
                        speed: 3.2,
                        direction: "none",
                        random: true,
                        straight: false,
                        outModes: { default: "bounce" },
                    },
                    links: {
                        enable: false,
                    },
                },
                interactivity: {
                    detectsOn: "canvas",
                    events: {
                        onHover: { enable: true, mode: ["repulse"] },
                        onClick: { enable: true, mode: "repulse" },
                        resize: { enable: true },
                    },
                    modes: {
                        repulse: { distance: 130, duration: 0.6 },
                    },
                },
                pauseOnBlur: false,
                pauseOnOutsideViewport: false,
            },
        });
    }

    function setupThemeWatcher() {
        if (!isActivePage()) return;

        const oldObserver = window.__friendsParticleThemeObserver;
        if (oldObserver) oldObserver.disconnect();

        const observer = new MutationObserver(() => {
            mountParticles();
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ["data-theme"],
        });

        window.__friendsParticleThemeObserver = observer;
    }

    function initEnhancements() {
        if (!isActivePage()) return;
        mountParticles();
        setupThemeWatcher();
    }

    initEnhancements();
    document.addEventListener("astro:page-load", initEnhancements);
    document.addEventListener("astro:after-swap", initEnhancements);
</script>