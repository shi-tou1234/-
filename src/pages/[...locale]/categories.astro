---
import MainPageLayout from '@layouts/MainPageLayout.astro'
import Cover from '@components/Cover.astro'

import { siteConfig } from '@/config'
import { getBlogEntrySort } from '@utils/content-utils'
import i18nit from '@i18n/translation'

import { i18n } from "astro:config/client";
import { getRelativeLocaleUrl } from '@utils/url-utils';

const currentLang = Astro.currentLocale || i18n!.defaultLocale;
const t = i18nit(currentLang);

export async function getStaticPaths() {
	return i18n?.locales.map(locale => ({ params: { locale: locale == i18n?.defaultLocale ? undefined : (locale as string) } }));
}

const allBlogPosts = await getBlogEntrySort(currentLang);
const uncategorized = currentLang === 'zh-cn' ? '未分类' : 'Uncategorized';

function encodeCategoryParam(category: string): string {
  return `b64-${Buffer.from(category, 'utf-8').toString('base64url')}`;
}

function getPostCategories(post: (typeof allBlogPosts)[number]): string[] {
  const legacyCategories = Array.isArray(post.data.categories)
    ? post.data.categories.map((item) => String(item).trim()).filter(Boolean)
    : [];
  const singleCategory = String(post.data.category || '').trim();
  const merged = [...legacyCategories, ...(singleCategory ? [singleCategory] : [])];
  const unique = [...new Set(merged)];
  return unique.length > 0 ? unique : [uncategorized];
}

const categoriesMap = allBlogPosts
  .filter((post) => post.id !== 'welcome')
  .reduce((acc, post) => {
  const categories = getPostCategories(post);
  categories.forEach((category) => {
    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(post);
  });
  return acc;
}, {} as Record<string, typeof allBlogPosts>);

const categories = Object.keys(categoriesMap).sort((a, b) => categoriesMap[b].length - categoriesMap[a].length || a.localeCompare(b));
const pageTitle = t("header.categories") + " - " + siteConfig.title;
---

<MainPageLayout title={pageTitle} lang={currentLang}>
  <div id="categories-particles" class="pointer-events-none fixed inset-0 -z-10"></div>
  <div class="relative z-10 mx-auto w-full max-w-[var(--page-width)]">
    <Cover title={t("cover.title.categories")} subTitle={t("cover.subTitle.categories", {count: categories.length})} />

    <div class="py-6 text-[var(--text-color)] grid grid-cols-1 sm:grid-cols-2 gap-3">
      {categories.map((category) => (
        <a href={getRelativeLocaleUrl(currentLang, `/categories/${encodeCategoryParam(category)}`)}
          class="group block rounded-lg border border-[var(--button-border-color)] p-3 transition-all duration-200 hover:-translate-y-0.5 hover:border-[var(--link-color)] hover:bg-[var(--button-hover-color)] active:translate-y-0">
          <div class="flex items-center justify-between gap-2">
            <span class="text-lg font-semibold transition-colors duration-200 group-hover:text-[var(--link-color)]">{category}</span>
            <span class="rounded-full border border-[var(--button-border-color)] px-2 py-0.5 text-xs text-[var(--text-color)]/70 transition-all duration-200 group-hover:border-[var(--link-color)] group-hover:text-[var(--link-color)] group-hover:bg-[var(--bg-color)]">{categoriesMap[category].length}</span>
          </div>
        </a>
      ))}
    </div>
  </div>
</MainPageLayout>

<script>
  import { tsParticles } from "@tsparticles/engine";
  import { loadSlim } from "@tsparticles/slim";

  const containerId = "categories-particles";

  function isActivePage() {
    return Boolean(document.getElementById(containerId));
  }

  function getParticleColor() {
    const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
    return currentTheme === "dark" ? "#ffffff" : "#0284c7";
  }

  async function mountParticles() {
    if (!isActivePage()) return;

    await loadSlim(tsParticles);

    const mounted = tsParticles.dom().find((item) => item.id === containerId);
    if (mounted) {
      await mounted.destroy();
    }

    const color = getParticleColor();

    await tsParticles.load({
      id: containerId,
      options: {
        fullScreen: { enable: true, zIndex: -1 },
        background: { color: "transparent" },
        fpsLimit: 60,
        detectRetina: true,
        particles: {
          number: { value: 160, density: { enable: true, area: 700 } },
          color: { value: color },
          opacity: { value: { min: 0.35, max: 0.95 } },
          size: { value: { min: 1.2, max: 3.8 } },
          move: {
            enable: true,
            speed: 3.2,
            direction: "none",
            random: true,
            straight: false,
            outModes: { default: "bounce" },
          },
          links: {
            enable: false,
          },
        },
        interactivity: {
          detectsOn: "canvas",
          events: {
            onHover: { enable: true, mode: ["repulse"] },
            onClick: { enable: true, mode: "repulse" },
            resize: { enable: true },
          },
          modes: {
            repulse: { distance: 130, duration: 0.6 },
          },
        },
        pauseOnBlur: false,
        pauseOnOutsideViewport: false,
      },
    });
  }

  function setupThemeWatcher() {
    if (!isActivePage()) return;

    const oldObserver = window.__categoriesParticleThemeObserver;
    if (oldObserver) oldObserver.disconnect();

    const observer = new MutationObserver(() => {
      mountParticles();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });

    window.__categoriesParticleThemeObserver = observer;
  }

  function initEnhancements() {
    if (!isActivePage()) return;
    mountParticles();
    setupThemeWatcher();
  }

  initEnhancements();
  document.addEventListener("astro:page-load", initEnhancements);
  document.addEventListener("astro:after-swap", initEnhancements);
</script>
