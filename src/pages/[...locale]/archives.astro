---
import MainPageLayout from '@layouts/MainPageLayout.astro'
import Cover from '@components/Cover.astro'

import { siteConfig } from '@/config'
import { getBlogEntrySort } from '@utils/content-utils'
import i18nit from '@i18n/translation'

import { i18n } from "astro:config/client";
import { getRelativeLocaleUrl } from '@utils/url-utils';



const currentLang = Astro.currentLocale || i18n!.defaultLocale;
const t = i18nit(currentLang);
const archiveTimeZone = currentLang.toLowerCase().startsWith('zh') ? 'Asia/Shanghai' : 'UTC';

export async function getStaticPaths() {
	return i18n?.locales.map(locale => ({ params: { locale: locale == i18n?.defaultLocale ? undefined : (locale as string) } }));
}

// 获取所有博客文章并按发布日期降序排序
const allBlogPosts = await getBlogEntrySort(currentLang);

const monthKeyFormatter = new Intl.DateTimeFormat('en-CA', {
    year: 'numeric',
    month: '2-digit',
    timeZone: archiveTimeZone,
});

const dayKeyFormatter = new Intl.DateTimeFormat('en-CA', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    timeZone: archiveTimeZone,
});

const getMonthKey = (date: Date) => monthKeyFormatter.format(date);

const getDayKey = (date: Date) => dayKeyFormatter.format(date);

const monthTitleFormatter = new Intl.DateTimeFormat(currentLang, {
    month: 'long',
    timeZone: archiveTimeZone,
});

const dayTitleFormatter = new Intl.DateTimeFormat(currentLang, {
    day: 'numeric',
    weekday: 'short',
    timeZone: archiveTimeZone,
});

// 按年份 -> 月份 -> 日期分组文章
const postsByYear = allBlogPosts.reduce((acc, post) => {
    const pubDate = post.data.pubDate;
    const year = pubDate.getFullYear();
    const monthKey = getMonthKey(pubDate);
    const dayKey = getDayKey(pubDate);

    if (!acc[year]) {
        acc[year] = {};
    }

    if (!acc[year][monthKey]) {
        acc[year][monthKey] = {};
    }

    if (!acc[year][monthKey][dayKey]) {
        acc[year][monthKey][dayKey] = [];
    }

    acc[year][monthKey][dayKey].push(post);
    return acc;
}, {} as Record<number, Record<string, Record<string, typeof allBlogPosts>>>);

const pageTitle = t("header.archive") + " - " + siteConfig.title;
const postNumber = allBlogPosts.length;
const indexPage = getRelativeLocaleUrl(currentLang, "");
---

<MainPageLayout title={pageTitle} lang={currentLang}>
    <div id="archives-particles" class="pointer-events-none fixed inset-0 z-0"></div>
    <div class="archives relative z-10 mx-auto w-full max-w-[var(--page-width)]">
        <Cover title={t("cover.title.archive")} subTitle={t("cover.subTitle.archive", {count: postNumber})}/>
        
        <div class="py-6 mx-auto text-[var(--text-color)]">
            {Object.keys(postsByYear).sort().reverse().map(year => (
                <div>
                    <h2 data-aos="fade-up" class="text-2xl font-bold my-4">{year}</h2>
                    <div>
                        {Object.keys(postsByYear[Number(year)]).sort().reverse().map((monthKey) => (
                            <div class="mb-4">
                                <h3 data-aos="fade-up" class="text-lg font-semibold my-3 text-[var(--text-color)]/90">
                                    {monthTitleFormatter.format(new Date(`${monthKey}-01T00:00:00`))}
                                </h3>

                                {Object.keys(postsByYear[Number(year)][monthKey]).sort().reverse().map((dayKey) => (
                                    <div class="mb-3">
                                        <h4 data-aos="fade-up" class="text-sm font-semibold my-2 text-[var(--text-color)]/70">
                                            {dayTitleFormatter.format(new Date(`${dayKey}T12:00:00Z`))}
                                        </h4>

                                        {postsByYear[Number(year)][monthKey][dayKey].map((post) => (
                                            <div class="pb-2">
                                                <a data-aos="fade-up" href={getRelativeLocaleUrl(currentLang, `/blog/${post.id}`)} 
                                                class="flex items-center gap-2 active:bg-[var(--button-hover-color)] hover:bg-[var(--button-hover-color)] p-2 rounded transition-colors duration-200 group">
                                                    <span class="text-lg group-hover:pl-2 group-hover:text-[var(--link-color)] group-hover:font-bold transition-all duration-200">
                                                        {post.data.title}
                                                        {
                                                            post.isFallback && (
                                                                <span class="self-center px-1 ml-2 text-sm text-[var(--text-color)]/70 font-mono uppercase bg-[var(--button-hover-color)] rounded border border-[var(--button-border-color)]">{i18n!.defaultLocale}</span>
                                                            )
                                                        }
                                                    </span>
                                                </a>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </div>
    </div>
</MainPageLayout>

<script>
    import { tsParticles } from "@tsparticles/engine";
    import { loadSlim } from "@tsparticles/slim";

    const containerId = "archives-particles";

    function isActivePage() {
        return Boolean(document.getElementById(containerId));
    }

    function getParticleColor() {
        const computed = getComputedStyle(document.documentElement);
        const linkColor = computed.getPropertyValue("--link-color").trim();
        if (linkColor) return linkColor;
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        return currentTheme === "dark" ? "#93c5fd" : "#1d4ed8";
    }

    async function mountParticles() {
        if (!isActivePage()) return;

        await loadSlim(tsParticles);

        const mounted = tsParticles.dom().find((item) => item.id === containerId);
        if (mounted) {
            await mounted.destroy();
        }

        const color = getParticleColor();

        await tsParticles.load({
            id: containerId,
            options: {
                fullScreen: { enable: false },
                background: { color: "transparent" },
                fpsLimit: 60,
                detectRetina: true,
                particles: {
                    number: { value: 90, density: { enable: true, area: 1000 } },
                    color: { value: color },
                    opacity: { value: { min: 0.14, max: 0.45 } },
                    size: { value: { min: 1, max: 2.6 } },
                    move: {
                        enable: true,
                        speed: 1.8,
                        direction: "none",
                        random: true,
                        straight: false,
                        outModes: { default: "bounce" },
                    },
                    links: {
                        enable: false,
                    },
                },
                interactivity: {
                    detectsOn: "canvas",
                    events: {
                        onHover: { enable: true, mode: ["repulse"] },
                        onClick: { enable: true, mode: "repulse" },
                        resize: { enable: true },
                    },
                    modes: {
                        repulse: { distance: 90, duration: 0.45 },
                    },
                },
                pauseOnBlur: false,
                pauseOnOutsideViewport: false,
            },
        });
    }

    function setupThemeWatcher() {
        if (!isActivePage()) return;

        const oldObserver = window.__archivesParticleThemeObserver;
        if (oldObserver) oldObserver.disconnect();

        const observer = new MutationObserver(() => {
            mountParticles();
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ["data-theme"],
        });

        window.__archivesParticleThemeObserver = observer;
    }

    function initEnhancements() {
        if (!isActivePage()) return;
        mountParticles();
        setupThemeWatcher();
    }

    initEnhancements();
    document.addEventListener("astro:page-load", initEnhancements);
    document.addEventListener("astro:after-swap", initEnhancements);
</script>