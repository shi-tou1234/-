---
import MainPageLayout from '@layouts/MainPageLayout.astro';
import { siteConfig } from '@/config';

const pageTitle = `后台管理 - ${siteConfig.title}`;
---

<MainPageLayout title={pageTitle} lang="zh-cn">
  <div class="mx-auto w-full max-w-[var(--page-width)] py-8">
    <h1 class="text-3xl font-bold text-[var(--text-color)] mb-4">后台管理</h1>
    <p class="text-[var(--text-color)]/70 mb-6">通过 GitHub API 直接写入仓库内容。首次使用请准备一个具有 repo 权限的 GitHub Token。</p>

    <section id="login-section" class="rounded-lg border border-[var(--button-border-color)] p-5 mb-6">
      <h2 class="text-xl font-semibold mb-3">登录</h2>
      <label class="block text-sm mb-2">后台密码</label>
      <div class="flex gap-3">
        <input id="admin-password" type="password" class="flex-1 rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="输入后台密码" />
        <button id="login-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">进入后台</button>
      </div>
      <p id="login-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
    </section>

    <section id="admin-panel" class="hidden space-y-6">
      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">安全设置</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-2">当前密码</label>
            <input id="old-password" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="输入当前密码" />
          </div>
          <div>
            <label class="block text-sm mb-2">新密码</label>
            <input id="new-password" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="输入新密码" />
          </div>
          <div class="flex items-end">
            <button id="change-password-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">修改密码</button>
          </div>
        </div>
        <p id="pwd-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">GitHub 连接</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-2">GitHub Token（repo 权限）</label>
            <input id="gh-token" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="ghp_xxx" />
          </div>
          <div>
            <label class="block text-sm mb-2">分支</label>
            <input id="gh-branch" type="text" value="main" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
          </div>
        </div>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">发布文章</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm mb-2">语言</label>
            <select id="post-lang" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2">
              <option value="zh-cn">中文（zh-cn）</option>
              <option value="en">English（en）</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-2">文章目录 slug（例如：my-first-post）</label>
            <input id="post-slug" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-2">标题</label>
            <input id="post-title" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-2">发布日期</label>
            <input id="post-date" type="date" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-2">简介</label>
            <input id="post-desc" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-2">分类（逗号分隔）</label>
            <input id="post-categories" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="技术,Astro" />
          </div>
        </div>

        <div class="mb-3 flex flex-wrap gap-3 items-center">
          <input id="post-files" type="file" multiple accept="image/*,video/*" class="text-sm" />
          <button id="upload-files-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">上传图片/视频到当前文章目录</button>
          <button id="insert-iframe-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">插入 iframe 模板</button>
        </div>

        <label class="block text-sm mb-2">Markdown 正文（支持 HTML 与 iframe）</label>
        <textarea id="post-content" class="w-full min-h-[320px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="在这里写文章内容"></textarea>

        <div class="mt-4 flex gap-3">
          <button id="publish-post-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">发布/更新文章</button>
          <button id="delete-post-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">删除当前语言文章</button>
          <button id="delete-post-all-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">删除整个博客目录</button>
          <a class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]" href="/-/" target="_blank">打开前台</a>
        </div>
        <p class="text-xs mt-2 text-[var(--text-color)]/60">删除当前语言文章：仅删除 `slug/lang.md`。删除整个博客目录：删除该 slug 下所有文件（含图片视频资源）。</p>
        <p id="post-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">编辑 About 内容</h2>
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <select id="about-lang" class="rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2">
            <option value="zh-cn">中文（zh-cn）</option>
            <option value="en">English（en）</option>
          </select>
          <button id="load-about-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">加载 About</button>
          <button id="save-about-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">保存 About</button>
        </div>
        <textarea id="about-content" class="w-full min-h-[220px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="About Markdown 内容"></textarea>
        <p id="about-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">编辑友链内容</h2>
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <button id="load-friends-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">加载友链</button>
          <button id="save-friends-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">保存友链</button>
        </div>
        <textarea id="friends-content" class="w-full min-h-[220px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder='请输入 JSON 数组，例如：[{"name":"GitHub","avatar":"...","url":"...","description":"..."}]'></textarea>
        <p id="friends-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">编辑右上角联系方式</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
          <div>
            <label class="block text-sm mb-2">GitHub 首页链接</label>
            <input id="header-github" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="https://github.com/your-name" />
          </div>
          <div>
            <label class="block text-sm mb-2">邮箱地址（点击图标复制）</label>
            <input id="header-email" type="email" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="you@example.com" />
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 mb-2">
          <button id="load-header-contact-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">加载联系方式</button>
          <button id="save-header-contact-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">保存联系方式</button>
        </div>
        <p id="header-contact-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>
    </section>
  </div>
</MainPageLayout>

<script>
  const SESSION_KEY = "cmchen_admin_ok";
  const ADMIN_GH_TOKEN_KEY = "cmchen_admin_gh_token";
  const ADMIN_GH_BRANCH_KEY = "cmchen_admin_gh_branch";
  const REPO_OWNER = "shi-tou1234";
  const REPO_NAME = "-";
  const ADMIN_SECURITY_PATH = "public/admin-security.json";
  const ADMIN_SECURITY_URL = `${window.location.origin}/-/admin-security.json`;
  const HEADER_CONTACT_PATH = "src/data/header-contact.ts";

  const fallbackSecurityConfig = {
    algorithm: "PBKDF2-SHA256",
    iterations: 150000,
    salt: "sZPlZ007W2b7Jl5bq4HwKA==",
    hash: "Y8U44x/bJKZkj056F/Ot0JVT0fs0rZS+xIsVE7dY/6Q="
  };

  let securityConfig = fallbackSecurityConfig;

  const loginSection = document.getElementById("login-section");
  const adminPanel = document.getElementById("admin-panel");
  const loginMsg = document.getElementById("login-msg");

  function setMsg(el, message, isError = false) {
    if (!el) return;
    el.textContent = message;
    el.style.color = isError ? "#dc2626" : "";
  }

  function unlockPanel() {
    loginSection?.classList.add("hidden");
    adminPanel?.classList.remove("hidden");
    sessionStorage.setItem(SESSION_KEY, "1");
  }

  function toBase64(bytes) {
    let binary = "";
    bytes.forEach((byte) => {
      binary += String.fromCharCode(byte);
    });
    return btoa(binary);
  }

  function fromBase64(base64) {
    return Uint8Array.from(atob(base64), char => char.charCodeAt(0));
  }

  async function hashPassword(password, saltBase64, iterations) {
    const encoder = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      "raw",
      encoder.encode(password),
      "PBKDF2",
      false,
      ["deriveBits"]
    );

    const bits = await crypto.subtle.deriveBits(
      {
        name: "PBKDF2",
        hash: "SHA-256",
        salt: fromBase64(saltBase64),
        iterations
      },
      keyMaterial,
      256
    );

    return toBase64(new Uint8Array(bits));
  }

  async function verifyPassword(password) {
    const hashed = await hashPassword(password, securityConfig.salt, securityConfig.iterations);
    return hashed === securityConfig.hash;
  }

  async function loadSecurityConfig() {
    try {
      const response = await fetch(`${ADMIN_SECURITY_URL}?t=${Date.now()}`);
      if (!response.ok) throw new Error("fetch failed");
      const json = await response.json();
      if (!json?.salt || !json?.hash || !json?.iterations) throw new Error("invalid config");
      securityConfig = json;
    } catch (_error) {
      securityConfig = fallbackSecurityConfig;
    }
  }

  if (sessionStorage.getItem(SESSION_KEY) === "1") {
    unlockPanel();
  }

  loadSecurityConfig();

  document.getElementById("login-btn")?.addEventListener("click", async () => {
    const pwd = document.getElementById("admin-password")?.value || "";
    const passed = await verifyPassword(pwd);
    if (passed) {
      setMsg(loginMsg, "登录成功");
      unlockPanel();
    } else {
      setMsg(loginMsg, "密码错误", true);
    }
  });

  document.getElementById("change-password-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("pwd-msg");
    const oldPwd = document.getElementById("old-password")?.value || "";
    const newPwd = document.getElementById("new-password")?.value || "";
    const token = getToken();
    const branch = getBranch();

    if (!token) {
      setMsg(msgEl, "请先填写 GitHub Token", true);
      return;
    }

    const oldPassed = await verifyPassword(oldPwd);
    if (!oldPassed) {
      setMsg(msgEl, "当前密码不正确", true);
      return;
    }
    if (newPwd.trim().length < 6) {
      setMsg(msgEl, "新密码至少 6 位", true);
      return;
    }

    const saltBytes = new Uint8Array(16);
    crypto.getRandomValues(saltBytes);
    const nextSecurity = {
      algorithm: "PBKDF2-SHA256",
      iterations: 180000,
      salt: toBase64(saltBytes),
      hash: await hashPassword(newPwd.trim(), toBase64(saltBytes), 180000)
    };

    await upsertFile(
      ADMIN_SECURITY_PATH,
      `${JSON.stringify(nextSecurity, null, 2)}\n`,
      "admin: update password hash",
      token,
      branch
    );

    securityConfig = nextSecurity;
    setMsg(msgEl, "密码修改成功，已全站生效（跨设备统一）");
    const oldInput = document.getElementById("old-password");
    const newInput = document.getElementById("new-password");
    if (oldInput) oldInput.value = "";
    if (newInput) newInput.value = "";
  });

  function getToken() {
    return (document.getElementById("gh-token")?.value || "").trim();
  }

  function getBranch() {
    return (document.getElementById("gh-branch")?.value || "main").trim();
  }

  function loadGitHubDraft() {
    const tokenInput = document.getElementById("gh-token");
    const branchInput = document.getElementById("gh-branch");
    const savedToken = localStorage.getItem(ADMIN_GH_TOKEN_KEY) || "";
    const savedBranch = localStorage.getItem(ADMIN_GH_BRANCH_KEY) || "main";
    if (tokenInput && savedToken) tokenInput.value = savedToken;
    if (branchInput && savedBranch) branchInput.value = savedBranch;
  }

  function saveGitHubDraft() {
    const token = getToken();
    const branch = getBranch();
    localStorage.setItem(ADMIN_GH_TOKEN_KEY, token);
    localStorage.setItem(ADMIN_GH_BRANCH_KEY, branch || "main");
  }

  loadGitHubDraft();
  document.getElementById("gh-token")?.addEventListener("change", saveGitHubDraft);
  document.getElementById("gh-branch")?.addEventListener("change", saveGitHubDraft);

  function encodeUtf8ToBase64(content) {
    return btoa(unescape(encodeURIComponent(content)));
  }

  async function githubRequest(path, token, options = {}) {
    const res = await fetch(`https://api.github.com${path}`, {
      ...options,
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: "application/vnd.github+json",
        ...(options.headers || {})
      }
    });

    if (!res.ok) {
      const text = await res.text();
      let detail = text;
      try {
        const parsed = JSON.parse(text);
        detail = parsed?.message || text;
      } catch (_e) {
        detail = text;
      }
      throw new Error(`GitHub API 错误 ${res.status}: ${detail}`);
    }

    return res.status === 204 ? null : res.json();
  }

  async function getFileMeta(repoPath, token, branch) {
    try {
      return await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(repoPath).replace(/%2F/g, "/")}?ref=${encodeURIComponent(branch)}`, token);
    } catch (error) {
      if (String(error).includes("404")) return null;
      throw error;
    }
  }

  async function upsertFile(repoPath, content, message, token, branch) {
    const meta = await getFileMeta(repoPath, token, branch);
    const body = {
      message,
      content: encodeUtf8ToBase64(content),
      branch,
      ...(meta?.sha ? { sha: meta.sha } : {})
    };

    await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(repoPath).replace(/%2F/g, "/")}`, token, {
      method: "PUT",
      body: JSON.stringify(body)
    });
  }

  async function deleteFile(repoPath, message, token, branch) {
    const meta = await getFileMeta(repoPath, token, branch);
    if (!meta?.sha) return false;

    await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(repoPath).replace(/%2F/g, "/")}`, token, {
      method: "DELETE",
      body: JSON.stringify({
        message,
        sha: meta.sha,
        branch
      })
    });

    return true;
  }

  async function listFilesByPrefix(prefix, token, branch) {
    const tree = await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/${encodeURIComponent(branch)}?recursive=1`, token);
    const items = Array.isArray(tree?.tree) ? tree.tree : [];

    return items
      .filter((item) => item?.type === "blob" && typeof item?.path === "string" && item.path.startsWith(prefix))
      .map((item) => item.path);
  }

  function decodeFileContent(raw) {
    return decodeURIComponent(escape(atob((raw || "").replace(/\n/g, ""))));
  }

  function parseFriendLinksFromTs(content) {
    const matched = content.match(/const\s+friendLinks:\s*FriendLink\[\]\s*=\s*(\[[\s\S]*?\])\s*\n\s*export\s+default\s+friendLinks/);
    if (!matched?.[1]) throw new Error("无法解析友链文件");
    return JSON.parse(matched[1]);
  }

  function buildFriendLinksTs(friendLinks) {
    return `import type { FriendLink } from "@/types/friend"\n\nconst friendLinks: FriendLink[] = ${JSON.stringify(friendLinks, null, 2)}\n\nexport default friendLinks\n`;
  }

  function parseHeaderContactFromTs(content) {
    const matched = content.match(/const\s+headerContact:\s*HeaderContact\s*=\s*(\{[\s\S]*?\})\s*\n\s*export\s+default\s+headerContact/);
    if (!matched?.[1]) throw new Error("无法解析联系方式文件");
    return JSON.parse(matched[1]);
  }

  function buildHeaderContactTs(contact) {
    return `export type HeaderContact = {\n  githubUrl: string\n  email: string\n}\n\nconst headerContact: HeaderContact = ${JSON.stringify(contact, null, 2)}\n\nexport default headerContact\n`;
  }

  function normalizeSlug(input) {
    return input
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "-")
      .replace(/[<>:"\\|?*#%{}\[\]^`~]/g, "")
      .replace(/\.{2,}/g, ".")
      .replace(/^-+|-+$/g, "");
  }

  function buildPostMarkdown(data) {
    const categories = data.categories.length
      ? `categories:\n${data.categories.map(c => `  - ${c}`).join("\n")}`
      : `categories: []`;

    return `---\ntitle: ${data.title}\npubDate: ${data.date}\ndraft: false\ndescription: ${data.description}\nslugId: ${data.slugId}\n${categories}\n---\n\n${data.content}\n`;
  }

  document.getElementById("insert-iframe-btn")?.addEventListener("click", () => {
    const textarea = document.getElementById("post-content");
    const iframeTpl = `\n<iframe src=\"https://www.youtube.com/embed/VIDEO_ID\" title=\"Video\" frameborder=\"0\" allowfullscreen></iframe>\n`;
    textarea.value = `${textarea.value || ""}${iframeTpl}`;
  });

  document.getElementById("upload-files-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const slug = normalizeSlug(document.getElementById("post-slug")?.value || "");
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const files = document.getElementById("post-files")?.files;

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!slug) throw new Error("请先填写文章 slug");
      if (!files || files.length === 0) throw new Error("请先选择文件");

      setMsg(msgEl, "上传中...");

      const uploaded = [];
      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const bytes = new Uint8Array(arrayBuffer);
        let binary = "";
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        const b64 = btoa(binary);

        const safeName = file.name.replace(/\s+/g, "-");
        const path = `src/content/blog/${slug}/assets/${safeName}`;

        const meta = await getFileMeta(path, token, branch);
        await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(path).replace(/%2F/g, "/")}`, token, {
          method: "PUT",
          body: JSON.stringify({
            message: `upload: ${safeName} for ${slug} (${lang})`,
            content: b64,
            branch,
            ...(meta?.sha ? { sha: meta.sha } : {})
          })
        });

        uploaded.push({ name: safeName, type: file.type });
      }

      const textarea = document.getElementById("post-content");
      const snippets = uploaded.map((f) => {
        if (f.type.startsWith("image/")) return `![${f.name}](./assets/${f.name})`;
        if (f.type.startsWith("video/")) return `<video controls src=\"./assets/${f.name}\"></video>`;
        return `[${f.name}](./assets/${f.name})`;
      }).join("\n\n");

      textarea.value = `${textarea.value || ""}\n\n${snippets}\n`;
      setMsg(msgEl, `上传成功：${uploaded.length} 个文件`);
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("publish-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const title = (document.getElementById("post-title")?.value || "").trim();
      const date = (document.getElementById("post-date")?.value || "").trim();
      const description = (document.getElementById("post-desc")?.value || "").trim();
      const categoriesRaw = (document.getElementById("post-categories")?.value || "").trim();
      const content = document.getElementById("post-content")?.value || "";
      const inputSlug = normalizeSlug(document.getElementById("post-slug")?.value || "");
      const fallbackSlug = normalizeSlug(title);
      const slug = inputSlug || fallbackSlug || `post-${Date.now()}`;

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!title || !date) throw new Error("请填写标题、发布日期");

      const slugInput = document.getElementById("post-slug");
      if (slugInput && !slugInput.value.trim()) {
        slugInput.value = slug;
      }

      const categories = categoriesRaw
        ? categoriesRaw.split(",").map(x => x.trim()).filter(Boolean)
        : [];

      const markdown = buildPostMarkdown({
        title,
        date,
        description,
        slugId: slug,
        categories,
        content
      });

      const path = `src/content/blog/${slug}/${lang}.md`;
      setMsg(msgEl, "发布中...");
      saveGitHubDraft();
      await upsertFile(path, markdown, `post: update ${slug}/${lang}`, token, branch);
      setMsg(msgEl, `发布成功：${path}`);
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("delete-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const slug = normalizeSlug(document.getElementById("post-slug")?.value || "");

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!slug) throw new Error("请先填写文章 slug");

      const path = `src/content/blog/${slug}/${lang}.md`;
      const confirmed = window.confirm(`确认删除文章文件？\n${path}`);
      if (!confirmed) return;

      setMsg(msgEl, "删除中...");
      saveGitHubDraft();
      const deleted = await deleteFile(path, `post: delete ${slug}/${lang}`, token, branch);

      if (!deleted) {
        throw new Error(`未找到文件：${path}`);
      }

      setMsg(msgEl, `删除成功：${path}`);
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("delete-post-all-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const slug = normalizeSlug(document.getElementById("post-slug")?.value || "");

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!slug) throw new Error("请先填写文章 slug");

      const prefix = `src/content/blog/${slug}/`;
      const confirmed = window.confirm(`确认删除整个博客目录？\n${prefix}\n\n这会删除该目录下所有语言文件和资源文件。`);
      if (!confirmed) return;

      setMsg(msgEl, "扫描目录中...");
      const files = await listFilesByPrefix(prefix, token, branch);
      if (files.length === 0) {
        throw new Error(`目录为空或不存在：${prefix}`);
      }

      setMsg(msgEl, `删除中...（共 ${files.length} 个文件）`);
      saveGitHubDraft();
      for (const file of files) {
        await deleteFile(file, `post: delete ${slug} directory`, token, branch);
      }

      setMsg(msgEl, `删除成功：${prefix}（已删除 ${files.length} 个文件）`);
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-about-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("about-lang")?.value || "zh-cn").trim();
      if (!token) throw new Error("请先填写 GitHub Token");

      const path = `src/content/spec/about/${lang}.md`;
      const meta = await getFileMeta(path, token, branch);
      const content = decodeFileContent(meta?.content || "");
      document.getElementById("about-content").value = content;
      setMsg(msgEl, "加载成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-about-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("about-lang")?.value || "zh-cn").trim();
      const content = document.getElementById("about-content")?.value || "";
      if (!token) throw new Error("请先填写 GitHub Token");

      const path = `src/content/spec/about/${lang}.md`;
      await upsertFile(path, content, `about: update ${lang}`, token, branch);
      setMsg(msgEl, "保存成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-friends-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("friends-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("请先填写 GitHub Token");

      const path = "src/data/friend-links.ts";
      const meta = await getFileMeta(path, token, branch);
      const content = decodeFileContent(meta?.content || "");
      const links = parseFriendLinksFromTs(content);
      document.getElementById("friends-content").value = JSON.stringify(links, null, 2);
      setMsg(msgEl, "友链加载成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-friends-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("friends-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const raw = document.getElementById("friends-content")?.value || "[]";
      if (!token) throw new Error("请先填写 GitHub Token");

      const links = JSON.parse(raw);
      if (!Array.isArray(links)) throw new Error("友链内容必须是 JSON 数组");

      links.forEach((item, index) => {
        if (
          typeof item?.name !== "string" ||
          typeof item?.avatar !== "string" ||
          typeof item?.url !== "string" ||
          typeof item?.description !== "string"
        ) {
          throw new Error(`第 ${index + 1} 条友链格式不正确`);
        }
      });

      const path = "src/data/friend-links.ts";
      const content = buildFriendLinksTs(links);
      await upsertFile(path, content, "friends: update links", token, branch);
      setMsg(msgEl, "友链保存成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-header-contact-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("header-contact-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("请先填写 GitHub Token");

      const meta = await getFileMeta(HEADER_CONTACT_PATH, token, branch);
      const content = decodeFileContent(meta?.content || "");
      const contact = parseHeaderContactFromTs(content);

      document.getElementById("header-github").value = contact.githubUrl || "";
      document.getElementById("header-email").value = contact.email || "";
      setMsg(msgEl, "联系方式加载成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-header-contact-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("header-contact-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const githubUrl = (document.getElementById("header-github")?.value || "").trim();
      const email = (document.getElementById("header-email")?.value || "").trim();

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!githubUrl) throw new Error("请填写 GitHub 首页链接");
      if (!email) throw new Error("请填写邮箱地址");

      const content = buildHeaderContactTs({ githubUrl, email });
      await upsertFile(HEADER_CONTACT_PATH, content, "header: update contact links", token, branch);
      setMsg(msgEl, "联系方式保存成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });
</script>
