---
import MainPageLayout from '@layouts/MainPageLayout.astro';
import { siteConfig } from '@/config';

const pageTitle = `åå°ç®¡ç† - ${siteConfig.title}`;
---

<MainPageLayout title={pageTitle} lang="zh-cn">
  <div class="mx-auto w-full max-w-[var(--page-width)] py-8">
    <h1 class="text-3xl font-bold text-[var(--text-color)] mb-4">åå°ç®¡ç†</h1>
    <p class="text-[var(--text-color)]/70 mb-6">é€šè¿‡ GitHub API ç›´æ¥å†™å…¥ä»“åº“å†…å®¹ã€‚é¦–æ¬¡ä½¿ç”¨è¯·å‡†å¤‡ä¸€ä¸ªå…·æœ‰ repo æƒé™çš„ GitHub Tokenã€‚</p>

    <section id="login-section" class="rounded-lg border border-[var(--button-border-color)] p-5 mb-6">
      <h2 class="text-xl font-semibold mb-3">ç™»å½•</h2>
      <label class="block text-sm mb-2">åå°å¯†ç </label>
      <div class="flex gap-3">
        <input id="admin-password" type="password" class="flex-1 rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="è¾“å…¥åå°å¯†ç " />
        <button id="login-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">è¿›å…¥åå°</button>
      </div>
      <p id="login-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
    </section>

    <section id="admin-panel" class="hidden space-y-6">
      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">å®‰å…¨è®¾ç½®</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-2">å½“å‰å¯†ç </label>
            <input id="old-password" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="è¾“å…¥å½“å‰å¯†ç " />
          </div>
          <div>
            <label class="block text-sm mb-2">æ–°å¯†ç </label>
            <input id="new-password" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="è¾“å…¥æ–°å¯†ç " />
          </div>
          <div class="flex items-end">
            <button id="change-password-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">ä¿®æ”¹å¯†ç </button>
          </div>
        </div>
        <p id="pwd-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">GitHub è¿æ¥</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-2">GitHub Tokenï¼ˆrepo æƒé™ï¼‰</label>
            <input id="gh-token" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="ghp_xxx" />
          </div>
          <div>
            <label class="block text-sm mb-2">åˆ†æ”¯</label>
            <input id="gh-branch" type="text" value="main" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
          </div>
        </div>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
          <h2 class="text-xl font-semibold">æ–‡ç« ç®¡ç†</h2>
          <div class="flex flex-wrap gap-2">
            <button id="refresh-post-list-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">åˆ·æ–°åˆ—è¡¨</button>
            <button id="new-post-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">æ–°å»ºæ–‡ç« </button>
            <a class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]" href="/-/" target="_blank">æ‰“å¼€å‰å°</a>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-1">
            <label class="block text-sm mb-2">å·²å‘å¸ƒæ–‡ç« ï¼ˆå¯ç›´æ¥ç¼–è¾‘ï¼‰</label>
            <select id="post-select" size="14" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2 text-sm"></select>
            <button id="load-selected-post-btn" class="mt-3 w-full rounded border border-[var(--button-border-color)] px-3 py-2 hover:bg-[var(--button-hover-color)]">ç¼–è¾‘æ‰€é€‰æ–‡ç« </button>
          </div>

          <div class="lg:col-span-2 space-y-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">è¯­è¨€</label>
                <select id="post-lang" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2">
                  <option value="zh-cn">ä¸­æ–‡ï¼ˆzh-cnï¼‰</option>
                  <option value="en">Englishï¼ˆenï¼‰</option>
                </select>
              </div>
              <div>
                <label class="block text-sm mb-1">slugï¼ˆå¯ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                <input id="post-slug" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="block text-sm mb-1">æ ‡é¢˜</label>
              <input id="post-title" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
            </div>

            <div>
              <label class="block text-sm mb-1">æ­£æ–‡ Markdown</label>
              <textarea id="post-content" class="w-full min-h-[280px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="åœ¨è¿™é‡Œå†™æ–‡ç« å†…å®¹"></textarea>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                <select id="post-md-snippet" class="rounded border border-[var(--button-border-color)] bg-transparent px-3 py-1.5 text-sm">
                  <option value="">é€‰æ‹© Markdown å¿«æ·è¯­æ³•</option>
                  <option value="app">åº”ç”¨ï¼ˆä¸‹è½½/è®¿é—®ï¼‰</option>
                  <option value="link">é“¾æ¥</option>
                  <option value="table">è¡¨æ ¼</option>
                  <option value="tip">æç¤ºå¡ç‰‡ï¼ˆtipï¼‰</option>
                  <option value="formula-inline">è¡Œå†…å…¬å¼</option>
                  <option value="formula-block">å—çº§å…¬å¼</option>
                  <option value="code-inline">è¡Œå†…ä»£ç </option>
                  <option value="code-block">ä»£ç å—</option>
                  <option value="bold">ç²—ä½“</option>
                  <option value="italic">æ–œä½“</option>
                  <option value="heading-2">æ ‡é¢˜ï¼ˆH2ï¼‰</option>
                  <option value="heading-3">æ ‡é¢˜ï¼ˆH3ï¼‰</option>
                  <option value="blockquote">å—å¼•ç”¨</option>
                  <option value="ul">æ— åºåˆ—è¡¨</option>
                  <option value="ol">æœ‰åºåˆ—è¡¨</option>
                  <option value="task">ä»»åŠ¡åˆ—è¡¨</option>
                  <option value="strike">åˆ é™¤çº¿</option>
                  <option value="hr">æ°´å¹³çº¿</option>
                </select>
                <button id="insert-md-snippet-btn" type="button" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 text-sm hover:bg-[var(--button-hover-color)]">æ’å…¥è¯­æ³•</button>
              </div>
            </div>

            <details class="rounded border border-[var(--button-border-color)] p-3">
              <summary class="cursor-pointer text-sm">æ›´å¤šè®¾ç½®ï¼ˆå¯é€‰ï¼‰</summary>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
                <div>
                  <label class="block text-sm mb-1">å‘å¸ƒæ—¥æœŸ</label>
                  <input id="post-date" type="datetime-local" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm mb-1">ç®€ä»‹</label>
                  <input id="post-desc" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm mb-1">å°é¢è·¯å¾„</label>
                  <input id="post-cover" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="ä¾‹å¦‚ï¼š./assets/cover.jpg" />
                </div>
                <div>
                  <label class="block text-sm mb-1">åˆ†ç±»</label>
                  <input id="post-category" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯" />
                </div>
              </div>
            </details>

            <div class="flex flex-wrap gap-2 items-center">
              <input id="post-files" type="file" multiple accept="image/*,video/*,.pdf,application/pdf" class="hidden" />
              <label for="post-files" class="cursor-pointer rounded border border-[var(--button-border-color)] px-3 py-1.5 text-sm font-medium text-[var(--text-color)] hover:bg-[var(--button-hover-color)]">é€‰æ‹©æ–‡ä»¶</label>
              <span id="post-files-count" class="text-sm text-[var(--text-color)]/70">æœªé€‰æ‹©æ–‡ä»¶</span>
              <button id="upload-files-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">ä¸Šä¼ èµ„æº</button>
              <button id="insert-iframe-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">æ’å…¥ iframe</button>
            </div>

            <div class="flex flex-wrap gap-2">
              <button id="publish-post-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">ä¿å­˜æ–‡ç« </button>
              <button id="delete-post-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">åˆ é™¤å½“å‰è¯­è¨€</button>
              <button id="delete-post-all-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">åˆ é™¤æ•´ä¸ªåšå®¢ç›®å½•</button>
            </div>
          </div>
        </div>

        <p id="post-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">ç«™ç‚¹å†…å®¹è®¾ç½®</h2>

        <div class="space-y-4">
          <div class="rounded border border-[var(--button-border-color)] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
              <div class="text-sm font-semibold">Aboutï¼ˆMarkdownï¼‰</div>
              <div class="flex flex-wrap items-center gap-2">
                <select id="about-lang" class="rounded border border-[var(--button-border-color)] bg-transparent px-3 py-1.5 text-sm">
                  <option value="zh-cn">ä¸­æ–‡ï¼ˆzh-cnï¼‰</option>
                  <option value="en">Englishï¼ˆenï¼‰</option>
                </select>
                <button id="load-about-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">åŠ è½½</button>
                <button id="save-about-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">ä¿å­˜</button>
              </div>
            </div>
            <textarea id="about-content" class="w-full min-h-[180px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="About Markdown å†…å®¹"></textarea>
            <p id="about-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
          </div>

          <div class="rounded border border-[var(--button-border-color)] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
              <div class="text-sm font-semibold">å…³äºç‰¹è´¨æ¨¡å—</div>
              <div class="flex flex-wrap items-center gap-2">
                <button id="load-about-profile-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">åŠ è½½</button>
                <button id="save-about-profile-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">ä¿å­˜</button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="about-mbti" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="MBTIï¼Œä¾‹å¦‚ï¼šINTP" />
              <input id="about-mbti-link" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="MBTI ä»‹ç»é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://www.16personalities.com/ch/intj-%E4%BA%BA%E6%A0%BC" />
              <input id="about-major" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="æ‰€å­¦ä¸“ä¸šï¼Œä¾‹å¦‚ï¼šç”µå­ä¿¡æ¯å·¥ç¨‹" />
              <input id="about-major-link" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="ä¸“ä¸šç™¾ç§‘é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://baike.baidu.com/item/%E7%94%B5%E5%AD%90%E4%BF%A1%E6%81%AF%E5%B7%A5%E7%A8%8B/87638" />
              <input id="about-recent-doing" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2 md:col-span-2" placeholder="æœ€è¿‘åœ¨åš" />
              <input id="about-recent-reading" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2 md:col-span-2" placeholder="æœ€è¿‘è¯»ä¹¦" />
            </div>
            <p id="about-profile-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
          </div>

          <div class="rounded border border-[var(--button-border-color)] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
              <div class="text-sm font-semibold">å‹é“¾ï¼ˆJSONï¼‰</div>
              <div class="flex flex-wrap items-center gap-2">
                <button id="load-friends-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">åŠ è½½</button>
                <button id="save-friends-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">ä¿å­˜</button>
              </div>
            </div>
            <textarea id="friends-content" class="w-full min-h-[180px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder='è¯·è¾“å…¥ JSON æ•°ç»„ï¼Œä¾‹å¦‚ï¼š[{"name":"GitHub","avatar":"...","url":"...","description":"..."}]'></textarea>
            <p id="friends-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
          </div>

          <div class="rounded border border-[var(--button-border-color)] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
              <div class="text-sm font-semibold">å³ä¸Šè§’è”ç³»æ–¹å¼</div>
              <div class="flex flex-wrap items-center gap-2">
                <button id="load-header-contact-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">åŠ è½½</button>
                <button id="save-header-contact-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">ä¿å­˜</button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="header-github" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="GitHub é¦–é¡µé“¾æ¥ï¼šhttps://github.com/your-name" />
              <input id="header-email" type="email" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="é‚®ç®±åœ°å€ï¼šyou@example.com" />
            </div>
            <p id="header-contact-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
          </div>
        </div>
      </div>
    </section>
  </div>
</MainPageLayout>

<script>
  import {
    AdminService,
    buildAboutProfileTs,
    buildFriendLinksTs,
    buildHeaderContactTs,
    buildPostMarkdown,
    decodeFileContent,
    getNowDateTimeLocal,
    normalizeSlug,
    parseAboutProfileFromTs,
    parseFriendLinksFromTs,
    parseHeaderContactFromTs,
    toIsoDateTime
  } from "@/utils/admin-service";

  const SESSION_KEY = "cmchen_admin_ok";
  const ADMIN_GH_TOKEN_KEY = "cmchen_admin_gh_token";
  const ADMIN_GH_BRANCH_KEY = "cmchen_admin_gh_branch";
  const REPO_OWNER = "shi-tou1234";
  const REPO_NAME = "-";
  const ADMIN_SECURITY_PATH = "public/admin-security.json";
  const ADMIN_SECURITY_URL = `${window.location.origin}/-/admin-security.json`;
  const HEADER_CONTACT_PATH = "src/data/header-contact.ts";
  const ABOUT_PROFILE_PATH = "src/data/about-profile.ts";

  const loginSection = document.getElementById("login-section");
  const adminPanel = document.getElementById("admin-panel");
  const loginMsg = document.getElementById("login-msg");

  const adminService = new AdminService({
    repoOwner: REPO_OWNER,
    repoName: REPO_NAME,
    securityPath: ADMIN_SECURITY_PATH,
    securityUrl: ADMIN_SECURITY_URL
  });

  function setMsg(el, message, isError = false) {
    if (!el) return;
    el.textContent = message;
    el.style.color = isError ? "#dc2626" : "";
  }

  function unlockPanel() {
    loginSection?.classList.add("hidden");
    adminPanel?.classList.remove("hidden");
    sessionStorage.setItem(SESSION_KEY, "1");
  }

  function getToken() {
    return (document.getElementById("gh-token")?.value || "").trim();
  }

  function getBranch() {
    return (document.getElementById("gh-branch")?.value || "main").trim();
  }

  function loadGitHubDraft() {
    const tokenInput = document.getElementById("gh-token");
    const branchInput = document.getElementById("gh-branch");
    const savedToken = localStorage.getItem(ADMIN_GH_TOKEN_KEY) || "";
    const savedBranch = localStorage.getItem(ADMIN_GH_BRANCH_KEY) || "main";
    if (tokenInput && savedToken) tokenInput.value = savedToken;
    if (branchInput && savedBranch) branchInput.value = savedBranch;
  }

  function saveGitHubDraft() {
    const token = getToken();
    const branch = getBranch();
    localStorage.setItem(ADMIN_GH_TOKEN_KEY, token);
    localStorage.setItem(ADMIN_GH_BRANCH_KEY, branch || "main");
  }

  async function verifyPassword(password) {
    return adminService.verifyPassword(password);
  }

  async function loadSecurityConfig() {
    await adminService.loadSecurityConfig();
  }

  async function githubRequest(path, token, options = {}) {
    return adminService.githubRequest(path, token, options);
  }

  async function getFileMeta(repoPath, token, branch) {
    return adminService.getFileMeta(repoPath, token, branch);
  }

  async function upsertFile(repoPath, content, message, token, branch) {
    return adminService.upsertFile(repoPath, content, message, token, branch);
  }

  async function fileToBase64(file) {
    const arrayBuffer = await file.arrayBuffer();
    const bytes = new Uint8Array(arrayBuffer);
    let binary = "";
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }

  async function uploadBlogAssetFile({ slug, lang, file, token, branch }) {
    const safeName = file.name.replace(/\s+/g, "-");
    const path = `src/content/blog/${slug}/assets/${safeName}`;
    const b64 = await fileToBase64(file);
    const meta = await getFileMeta(path, token, branch);

    await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(path).replace(/%2F/g, "/")}`, token, {
      method: "PUT",
      body: JSON.stringify({
        message: `upload: ${safeName} for ${slug} (${lang})`,
        content: b64,
        branch,
        ...(meta?.sha ? { sha: meta.sha } : {})
      })
    });

    return { name: safeName, type: file.type || "application/octet-stream" };
  }

  async function renderPdfPagesToImages(file) {
    const pdfjsLib = await import("pdfjs-dist");
    const workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.624/build/pdf.worker.min.mjs";
    pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc;

    const pdfData = new Uint8Array(await file.arrayBuffer());
    const loadingTask = pdfjsLib.getDocument({ data: pdfData });
    const pdfDoc = await loadingTask.promise;

    const baseName = file.name.replace(/\.pdf$/i, "").replace(/\s+/g, "-");
    const generatedFiles = [];

    for (let pageNo = 1; pageNo <= pdfDoc.numPages; pageNo++) {
      const page = await pdfDoc.getPage(pageNo);
      const viewport = page.getViewport({ scale: 1.8 });
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      if (!context) throw new Error("PDF æ¸²æŸ“å¤±è´¥ï¼šæ— æ³•åˆ›å»ºç”»å¸ƒä¸Šä¸‹æ–‡");

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      context.fillStyle = "#ffffff";
      context.fillRect(0, 0, canvas.width, canvas.height);

      await page.render({
        canvasContext: context,
        viewport,
        background: "#ffffff",
        annotationMode: pdfjsLib.AnnotationMode.ENABLE,
        renderInteractiveForms: true
      }).promise;

      const blob = await new Promise((resolve, reject) => {
        canvas.toBlob((result) => {
          if (result) resolve(result);
          else reject(new Error("PDF è½¬å›¾ç‰‡å¤±è´¥"));
        }, "image/png");
      });

      const fileName = `${baseName}-p${String(pageNo).padStart(2, "0")}.png`;
      generatedFiles.push(new File([blob], fileName, { type: "image/png" }));
    }

    return generatedFiles;
  }

  async function deleteFile(repoPath, message, token, branch) {
    return adminService.deleteFile(repoPath, message, token, branch);
  }

  async function listFilesByPrefix(prefix, token, branch) {
    return adminService.listFilesByPrefix(prefix, token, branch);
  }

  async function listBlogMarkdownEntries(token, branch) {
    return adminService.listBlogMarkdownEntries(token, branch);
  }

  if (sessionStorage.getItem(SESSION_KEY) === "1") {
    unlockPanel();
  }

  loadGitHubDraft();
  document.getElementById("gh-token")?.addEventListener("change", saveGitHubDraft);
  document.getElementById("gh-branch")?.addEventListener("change", saveGitHubDraft);

  loadSecurityConfig();

  if (sessionStorage.getItem(SESSION_KEY) === "1") {
    loadPostList().catch((error) => {
      setMsg(document.getElementById("post-msg"), String(error), true);
    });
  }

  document.getElementById("login-btn")?.addEventListener("click", async () => {
    const pwd = document.getElementById("admin-password")?.value || "";
    const passed = await verifyPassword(pwd);
    if (passed) {
      setMsg(loginMsg, "ç™»å½•æˆåŠŸ");
      unlockPanel();
      loadPostList().catch((error) => {
        setMsg(document.getElementById("post-msg"), String(error), true);
      });
    } else {
      setMsg(loginMsg, "å¯†ç é”™è¯¯", true);
    }
  });

  document.getElementById("change-password-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("pwd-msg");
    const oldPwd = document.getElementById("old-password")?.value || "";
    const newPwd = document.getElementById("new-password")?.value || "";
    const token = getToken();
    const branch = getBranch();

    if (!token) {
      setMsg(msgEl, "è¯·å…ˆå¡«å†™ GitHub Token", true);
      return;
    }

    await adminService.changePassword({
      oldPassword: oldPwd,
      newPassword: newPwd,
      token,
      branch
    });

    setMsg(msgEl, "å¯†ç ä¿®æ”¹æˆåŠŸï¼Œå·²å…¨ç«™ç”Ÿæ•ˆï¼ˆè·¨è®¾å¤‡ç»Ÿä¸€ï¼‰");
    const oldInput = document.getElementById("old-password");
    const newInput = document.getElementById("new-password");
    if (oldInput) oldInput.value = "";
    if (newInput) newInput.value = "";
  });

  function initPostDateDefault() {
    const input = document.getElementById("post-date");
    if (input && !input.value) {
      input.value = getNowDateTimeLocal();
    }
  }

  function toDateTimeLocalValue(isoLikeValue) {
    if (!isoLikeValue) return "";
    const date = new Date(isoLikeValue);
    if (Number.isNaN(date.getTime())) return "";
    const pad = (n) => String(n).padStart(2, "0");
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function parsePostMarkdown(markdown) {
    const matched = markdown.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);
    if (!matched) {
      return {
        frontmatter: {},
        content: markdown || ""
      };
    }

    const rawFrontmatter = matched[1] || "";
    const bodyContent = matched[2] || "";
    const frontmatter = {};
    rawFrontmatter.split("\n").forEach((line) => {
      const idx = line.indexOf(":");
      if (idx <= 0) return;
      const key = line.slice(0, idx).trim();
      const value = line.slice(idx + 1).trim();
      frontmatter[key] = value;
    });

    return { frontmatter, content: bodyContent };
  }

  function clearPostEditor() {
    const titleInput = document.getElementById("post-title");
    const slugInput = document.getElementById("post-slug");
    const langInput = document.getElementById("post-lang");
    const dateInput = document.getElementById("post-date");
    const descInput = document.getElementById("post-desc");
    const coverInput = document.getElementById("post-cover");
    const categoryInput = document.getElementById("post-category");
    const contentInput = document.getElementById("post-content");

    if (titleInput) titleInput.value = "";
    if (slugInput) slugInput.value = "";
    if (langInput) langInput.value = "zh-cn";
    if (dateInput) dateInput.value = getNowDateTimeLocal();
    if (descInput) descInput.value = "";
    if (coverInput) coverInput.value = "";
    if (categoryInput) categoryInput.value = "";
    if (contentInput) contentInput.value = "";
  }

  function getSelectedPostSlug() {
    const selectEl = document.getElementById("post-select");
    const selectedPath = selectEl?.value || "";
    if (!selectedPath) return "";
    const matched = selectedPath.match(/^src\/content\/blog\/(.+)\/(zh-cn|en)\.md$/);
    return matched?.[1] || "";
  }

  function ensurePostSlug() {
    const slugInput = document.getElementById("post-slug");
    const title = (document.getElementById("post-title")?.value || "").trim();
    const currentSlug = normalizeSlug(slugInput?.value || "");
    if (currentSlug) {
      if (slugInput) slugInput.value = currentSlug;
      return currentSlug;
    }

    const selectedSlug = normalizeSlug(getSelectedPostSlug());
    if (selectedSlug) {
      if (slugInput) slugInput.value = selectedSlug;
      return selectedSlug;
    }

    const titleSlug = normalizeSlug(title);
    const fallbackSlug = titleSlug || `post-${Date.now()}`;
    if (slugInput) slugInput.value = fallbackSlug;
    return fallbackSlug;
  }

  async function loadPostList() {
    const msgEl = document.getElementById("post-msg");
    const selectEl = document.getElementById("post-select");
    const token = getToken();
    const branch = getBranch();

    if (!token) {
      if (selectEl) {
        selectEl.innerHTML = "";
      }
      setMsg(msgEl, "è¯·å…ˆå¡«å†™ GitHub Token åå†åŠ è½½æ–‡ç« åˆ—è¡¨", true);
      return;
    }

    setMsg(msgEl, "åŠ è½½æ–‡ç« åˆ—è¡¨ä¸­...");
    saveGitHubDraft();
    const entries = await listBlogMarkdownEntries(token, branch);

    if (selectEl) {
      selectEl.innerHTML = "";
      if (entries.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "æš‚æ— æ–‡ç« ";
        selectEl.appendChild(option);
      } else {
        entries.forEach((entry) => {
          const option = document.createElement("option");
          option.value = entry.path;
          option.textContent = `${entry.slug} (${entry.lang})`;
          selectEl.appendChild(option);
        });
      }
    }

    setMsg(msgEl, `å·²åŠ è½½ ${entries.length} ç¯‡æ–‡ç« `);
  }

  async function loadSelectedPostToEditor() {
    const msgEl = document.getElementById("post-msg");
    const selectEl = document.getElementById("post-select");
    const selectedPath = selectEl?.value || "";
    const token = getToken();
    const branch = getBranch();

    if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");
    if (!selectedPath) throw new Error("è¯·å…ˆé€‰æ‹©æ–‡ç« ");

    const meta = await getFileMeta(selectedPath, token, branch);
    if (!meta?.content) throw new Error("æ–‡ç« å†…å®¹ä¸ºç©ºæˆ–ä¸å­˜åœ¨");

    const rawMarkdown = decodeFileContent(meta.content);
    const { frontmatter, content } = parsePostMarkdown(rawMarkdown);

    const slugMatched = selectedPath.match(/^src\/content\/blog\/(.+)\/(zh-cn|en)\.md$/);
    const slug = slugMatched?.[1] || "";
    const lang = slugMatched?.[2] || "zh-cn";

    const titleInput = document.getElementById("post-title");
    const slugInput = document.getElementById("post-slug");
    const langInput = document.getElementById("post-lang");
    const dateInput = document.getElementById("post-date");
    const descInput = document.getElementById("post-desc");
    const coverInput = document.getElementById("post-cover");
    const categoryInput = document.getElementById("post-category");
    const contentInput = document.getElementById("post-content");

    if (titleInput) titleInput.value = frontmatter.title || "";
    if (slugInput) slugInput.value = slug;
    if (langInput) langInput.value = lang;
    if (dateInput) dateInput.value = toDateTimeLocalValue(frontmatter.pubDate || "") || getNowDateTimeLocal();
    if (descInput) descInput.value = frontmatter.description || "";
    if (coverInput) coverInput.value = frontmatter.image || "";
    if (categoryInput) categoryInput.value = frontmatter.category || "";
    if (contentInput) contentInput.value = (content || "").trim();

    setMsg(msgEl, `å·²è½½å…¥ï¼š${slug} (${lang})`);
  }

  initPostDateDefault();
  document.getElementById("post-files")?.addEventListener("change", () => {
    const files = document.getElementById("post-files")?.files;
    const countEl = document.getElementById("post-files-count");
    if (!countEl) return;
    const count = files?.length || 0;
    countEl.textContent = count > 0 ? `å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶` : "æœªé€‰æ‹©æ–‡ä»¶";
  });

  document.getElementById("refresh-post-list-btn")?.addEventListener("click", loadPostList);
  document.getElementById("load-selected-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      await loadSelectedPostToEditor();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });
  document.getElementById("new-post-btn")?.addEventListener("click", () => {
    clearPostEditor();
    setMsg(document.getElementById("post-msg"), "å·²åˆ‡æ¢åˆ°æ–°å»ºæ–‡ç« æ¨¡å¼");
  });
  document.getElementById("post-select")?.addEventListener("dblclick", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      await loadSelectedPostToEditor();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("insert-iframe-btn")?.addEventListener("click", () => {
    const textarea = document.getElementById("post-content");
    const iframeTpl = `\n<iframe src=\"https://www.youtube.com/embed/VIDEO_ID\" title=\"Video\" frameborder=\"0\" allowfullscreen></iframe>\n`;
    textarea.value = `${textarea.value || ""}${iframeTpl}`;
  });

  function insertAtCursor(textarea, beforeText, afterText = "", fallbackSelection = "") {
    if (!textarea) return;

    const start = textarea.selectionStart ?? textarea.value.length;
    const end = textarea.selectionEnd ?? textarea.value.length;
    const selected = textarea.value.slice(start, end);
    const inner = selected || fallbackSelection;
    const insertion = `${beforeText}${inner}${afterText}`;

    textarea.setRangeText(insertion, start, end, "end");
    textarea.focus();
  }

  function insertMarkdownSnippet(type) {
    const textarea = document.getElementById("post-content");
    if (!textarea || !type) return;

    const snippets = {
      app: () => insertAtCursor(textarea, "[ğŸ“± åº”ç”¨åç§°](https://example.com)\n\n> ç®€ä»‹ï¼šä¸€å¥è¯è¯´æ˜è¿™ä¸ªåº”ç”¨é€‚åˆåšä»€ä¹ˆã€‚\n"),
      link: () => insertAtCursor(textarea, "[é“¾æ¥æ ‡é¢˜](https://example.com)"),
      table: () => insertAtCursor(textarea, "| åˆ—1 | åˆ—2 | åˆ—3 |\n| --- | --- | --- |\n| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |\n"),
      tip: () => insertAtCursor(textarea, ":::tip\nè¿™é‡Œå¡«å†™æç¤ºå†…å®¹\n:::\n"),
      "formula-inline": () => insertAtCursor(textarea, "$", "$", "a^2+b^2=c^2"),
      "formula-block": () => insertAtCursor(textarea, "$$\n", "\n$$\n", "\\int_a^b f(x)\\,dx"),
      "code-inline": () => insertAtCursor(textarea, "`", "`", "code"),
      "code-block": () => insertAtCursor(textarea, "```ts\n", "\n```\n", "console.log('hello')"),
      bold: () => insertAtCursor(textarea, "**", "**", "åŠ ç²—æ–‡æœ¬"),
      italic: () => insertAtCursor(textarea, "*", "*", "æ–œä½“æ–‡æœ¬"),
      "heading-2": () => insertAtCursor(textarea, "## äºŒçº§æ ‡é¢˜\n"),
      "heading-3": () => insertAtCursor(textarea, "### ä¸‰çº§æ ‡é¢˜\n"),
      blockquote: () => insertAtCursor(textarea, "> è¿™æ˜¯ä¸€æ®µå¼•ç”¨\n"),
      ul: () => insertAtCursor(textarea, "- åˆ—è¡¨é¡¹ 1\n- åˆ—è¡¨é¡¹ 2\n"),
      ol: () => insertAtCursor(textarea, "1. åˆ—è¡¨é¡¹ 1\n2. åˆ—è¡¨é¡¹ 2\n"),
      task: () => insertAtCursor(textarea, "- [ ] å¾…åŠäº‹é¡¹\n- [x] å·²å®Œæˆäº‹é¡¹\n"),
      strike: () => insertAtCursor(textarea, "~~", "~~", "åˆ é™¤çº¿æ–‡æœ¬"),
      hr: () => insertAtCursor(textarea, "\n---\n"),
    };

    const handler = snippets[type];
    if (!handler) return;
    handler();
  }

  document.getElementById("insert-md-snippet-btn")?.addEventListener("click", () => {
    const selectEl = document.getElementById("post-md-snippet");
    const type = (selectEl?.value || "").trim();
    if (!type) return;
    insertMarkdownSnippet(type);
  });

  document.getElementById("upload-files-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const slug = ensurePostSlug();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const files = document.getElementById("post-files")?.files;

      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");
      if (!files || files.length === 0) throw new Error("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");

      setMsg(msgEl, `ä¸Šä¼ ä¸­...ï¼ˆ${files.length} ä¸ªæ–‡ä»¶ï¼‰`);

      const uploaded = [];
      for (const file of files) {
        const isPdf = file.type === "application/pdf" || /\.pdf$/i.test(file.name);

        if (isPdf) {
          setMsg(msgEl, `æ­£åœ¨è½¬æ¢ PDFï¼š${file.name}`);
          const imageFiles = await renderPdfPagesToImages(file);
          for (const imageFile of imageFiles) {
            const result = await uploadBlogAssetFile({ slug, lang, file: imageFile, token, branch });
            uploaded.push({ ...result, fromPdf: true });
          }
          continue;
        }

        const result = await uploadBlogAssetFile({ slug, lang, file, token, branch });
        uploaded.push({ ...result, fromPdf: false });
      }

      const textarea = document.getElementById("post-content");
      const coverInput = document.getElementById("post-cover");
      const firstImage = uploaded.find((f) => f.type.startsWith("image/") && !f.fromPdf);
      const coverWasEmpty = !!(coverInput && !coverInput.value.trim());
      const coverNameToSkip = coverWasEmpty && firstImage ? firstImage.name : "";

      const snippets = uploaded.filter((f) => f.name !== coverNameToSkip).map((f) => {
        if (f.type.startsWith("image/")) return `![${f.name}](./assets/${f.name})`;
        if (f.type.startsWith("video/")) return `<video controls src=\"./assets/${f.name}\"></video>`;
        return `[${f.name}](./assets/${f.name})`;
      }).join("\n\n");

      if (coverInput && !coverInput.value.trim() && firstImage) {
        coverInput.value = `./assets/${firstImage.name}`;
      }

      if (snippets) {
        textarea.value = `${textarea.value || ""}\n\n${snippets}\n`;
      }
      const fileInput = document.getElementById("post-files");
      if (fileInput) fileInput.value = "";
      const countEl = document.getElementById("post-files-count");
      if (countEl) countEl.textContent = "æœªé€‰æ‹©æ–‡ä»¶";
      const coverMsg = coverNameToSkip ? `ï¼Œå·²å°† ${coverNameToSkip} è®¾ä¸ºå°é¢ä¸”ä¸æ’å…¥æ­£æ–‡` : "";
      setMsg(msgEl, `ä¸Šä¼ æˆåŠŸï¼š${uploaded.length} ä¸ªæ–‡ä»¶ï¼ˆç›®å½•ï¼š${slug}/assetsï¼‰${coverMsg}`);
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("publish-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const title = (document.getElementById("post-title")?.value || "").trim();
      const dateInput = (document.getElementById("post-date")?.value || "").trim();
      const date = toIsoDateTime(dateInput) || new Date().toISOString();
      const description = (document.getElementById("post-desc")?.value || "").trim();
      const image = (document.getElementById("post-cover")?.value || "").trim();
      const category = (document.getElementById("post-category")?.value || "").trim();
      const content = document.getElementById("post-content")?.value || "";
      const inputSlug = ensurePostSlug();
      const fallbackSlug = normalizeSlug(title);
      const slug = inputSlug || fallbackSlug || `post-${Date.now()}`;

      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");
      if (!title) throw new Error("è¯·å¡«å†™æ ‡é¢˜");

      const slugInput = document.getElementById("post-slug");
      if (slugInput && !slugInput.value.trim()) {
        slugInput.value = slug;
      }

      const markdown = buildPostMarkdown({
        title,
        date,
        description,
        image,
        category,
        slugId: slug,
        content
      });

      const path = `src/content/blog/${slug}/${lang}.md`;
      setMsg(msgEl, "å‘å¸ƒä¸­...");
      saveGitHubDraft();
      await upsertFile(path, markdown, `post: update ${slug}/${lang}`, token, branch);
      setMsg(msgEl, `å‘å¸ƒæˆåŠŸï¼š${path}`);
      await loadPostList();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("delete-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const slug = ensurePostSlug();

      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const path = `src/content/blog/${slug}/${lang}.md`;
      const confirmed = window.confirm(`ç¡®è®¤åˆ é™¤æ–‡ç« æ–‡ä»¶ï¼Ÿ\n${path}`);
      if (!confirmed) return;

      setMsg(msgEl, "åˆ é™¤ä¸­...");
      saveGitHubDraft();
      const deleted = await deleteFile(path, `post: delete ${slug}/${lang}`, token, branch);

      if (!deleted) {
        throw new Error(`æœªæ‰¾åˆ°æ–‡ä»¶ï¼š${path}`);
      }

      setMsg(msgEl, `åˆ é™¤æˆåŠŸï¼š${path}`);
      await loadPostList();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("delete-post-all-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const slug = ensurePostSlug();

      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const prefix = `src/content/blog/${slug}/`;
      const confirmed = window.confirm(`ç¡®è®¤åˆ é™¤æ•´ä¸ªåšå®¢ç›®å½•ï¼Ÿ\n${prefix}\n\nè¿™ä¼šåˆ é™¤è¯¥ç›®å½•ä¸‹æ‰€æœ‰è¯­è¨€æ–‡ä»¶å’Œèµ„æºæ–‡ä»¶ã€‚`);
      if (!confirmed) return;

      setMsg(msgEl, "æ‰«æç›®å½•ä¸­...");
      const files = await listFilesByPrefix(prefix, token, branch);
      if (files.length === 0) {
        throw new Error(`ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼š${prefix}`);
      }

      setMsg(msgEl, `åˆ é™¤ä¸­...ï¼ˆå…± ${files.length} ä¸ªæ–‡ä»¶ï¼‰`);
      saveGitHubDraft();
      for (const file of files) {
        await deleteFile(file, `post: delete ${slug} directory`, token, branch);
      }

      setMsg(msgEl, `åˆ é™¤æˆåŠŸï¼š${prefix}ï¼ˆå·²åˆ é™¤ ${files.length} ä¸ªæ–‡ä»¶ï¼‰`);
      await loadPostList();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-about-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("about-lang")?.value || "zh-cn").trim();
      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const path = `src/content/spec/about/${lang}.md`;
      const meta = await getFileMeta(path, token, branch);
      const content = decodeFileContent(meta?.content || "");
      document.getElementById("about-content").value = content;
      setMsg(msgEl, "åŠ è½½æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-about-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("about-lang")?.value || "zh-cn").trim();
      const content = document.getElementById("about-content")?.value || "";
      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const path = `src/content/spec/about/${lang}.md`;
      await upsertFile(path, content, `about: update ${lang}`, token, branch);
      setMsg(msgEl, "ä¿å­˜æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-about-profile-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-profile-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const meta = await getFileMeta(ABOUT_PROFILE_PATH, token, branch);
      const content = decodeFileContent(meta?.content || "");
      const profile = parseAboutProfileFromTs(content);

      document.getElementById("about-mbti").value = profile.mbti || "";
      document.getElementById("about-mbti-link").value = profile.mbtiLink || "";
      document.getElementById("about-major").value = profile.major || "";
      document.getElementById("about-major-link").value = profile.majorLink || "";
      document.getElementById("about-recent-doing").value = profile.recentDoing || "";
      document.getElementById("about-recent-reading").value = profile.recentReading || "";
      setMsg(msgEl, "å…³äºç‰¹è´¨åŠ è½½æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-about-profile-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-profile-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const mbti = (document.getElementById("about-mbti")?.value || "").trim();
      const mbtiLink = (document.getElementById("about-mbti-link")?.value || "").trim();
      const major = (document.getElementById("about-major")?.value || "").trim();
      const majorLink = (document.getElementById("about-major-link")?.value || "").trim();
      const recentDoing = (document.getElementById("about-recent-doing")?.value || "").trim();
      const recentReading = (document.getElementById("about-recent-reading")?.value || "").trim();

      if (!mbti) throw new Error("è¯·å¡«å†™ MBTI");
      if (!mbtiLink) throw new Error("è¯·å¡«å†™ MBTI ä»‹ç»é“¾æ¥");
      if (!major) throw new Error("è¯·å¡«å†™æ‰€å­¦ä¸“ä¸š");
      if (!majorLink) throw new Error("è¯·å¡«å†™ä¸“ä¸šç™¾ç§‘é“¾æ¥");
      if (!recentDoing) throw new Error("è¯·å¡«å†™æœ€è¿‘åœ¨åš");
      if (!recentReading) throw new Error("è¯·å¡«å†™æœ€è¿‘è¯»ä¹¦");

      const content = buildAboutProfileTs({ mbti, mbtiLink, major, majorLink, recentDoing, recentReading });
      await upsertFile(ABOUT_PROFILE_PATH, content, "about: update profile", token, branch);
      setMsg(msgEl, "å…³äºç‰¹è´¨ä¿å­˜æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-friends-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("friends-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const path = "src/data/friend-links.ts";
      const meta = await getFileMeta(path, token, branch);
      const content = decodeFileContent(meta?.content || "");
      const links = parseFriendLinksFromTs(content);
      document.getElementById("friends-content").value = JSON.stringify(links, null, 2);
      setMsg(msgEl, "å‹é“¾åŠ è½½æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-friends-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("friends-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const raw = document.getElementById("friends-content")?.value || "[]";
      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const links = JSON.parse(raw);
      if (!Array.isArray(links)) throw new Error("å‹é“¾å†…å®¹å¿…é¡»æ˜¯ JSON æ•°ç»„");

      links.forEach((item, index) => {
        if (
          typeof item?.name !== "string" ||
          typeof item?.avatar !== "string" ||
          typeof item?.url !== "string" ||
          typeof item?.description !== "string"
        ) {
          throw new Error(`ç¬¬ ${index + 1} æ¡å‹é“¾æ ¼å¼ä¸æ­£ç¡®`);
        }
      });

      const path = "src/data/friend-links.ts";
      const content = buildFriendLinksTs(links);
      await upsertFile(path, content, "friends: update links", token, branch);
      setMsg(msgEl, "å‹é“¾ä¿å­˜æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-header-contact-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("header-contact-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");

      const meta = await getFileMeta(HEADER_CONTACT_PATH, token, branch);
      const content = decodeFileContent(meta?.content || "");
      const contact = parseHeaderContactFromTs(content);

      document.getElementById("header-github").value = contact.githubUrl || "";
      document.getElementById("header-email").value = contact.email || "";
      setMsg(msgEl, "è”ç³»æ–¹å¼åŠ è½½æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-header-contact-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("header-contact-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const githubUrl = (document.getElementById("header-github")?.value || "").trim();
      const email = (document.getElementById("header-email")?.value || "").trim();

      if (!token) throw new Error("è¯·å…ˆå¡«å†™ GitHub Token");
      if (!githubUrl) throw new Error("è¯·å¡«å†™ GitHub é¦–é¡µé“¾æ¥");
      if (!email) throw new Error("è¯·å¡«å†™é‚®ç®±åœ°å€");

      const content = buildHeaderContactTs({ githubUrl, email });
      await upsertFile(HEADER_CONTACT_PATH, content, "header: update contact links", token, branch);
      setMsg(msgEl, "è”ç³»æ–¹å¼ä¿å­˜æˆåŠŸ");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });
</script>
