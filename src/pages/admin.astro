---
import MainPageLayout from '@layouts/MainPageLayout.astro';
import { siteConfig } from '@/config';

const pageTitle = `后台管理 - ${siteConfig.title}`;
---

<MainPageLayout title={pageTitle} lang="zh-cn">
  <div class="mx-auto w-full max-w-[var(--page-width)] py-8">
    <h1 class="text-3xl font-bold text-[var(--text-color)] mb-4">后台管理</h1>
    <p class="text-[var(--text-color)]/70 mb-6">通过 GitHub API 直接写入仓库内容。首次使用请准备一个具有 repo 权限的 GitHub Token。</p>

    <section id="login-section" class="rounded-lg border border-[var(--button-border-color)] p-5 mb-6">
      <h2 class="text-xl font-semibold mb-3">登录</h2>
      <label class="block text-sm mb-2">后台密码</label>
      <div class="flex gap-3">
        <input id="admin-password" type="password" class="flex-1 rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="输入后台密码" />
        <button id="login-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">进入后台</button>
      </div>
      <p id="login-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
    </section>

    <section id="admin-panel" class="hidden space-y-6">
      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">安全设置</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-2">当前密码</label>
            <input id="old-password" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="输入当前密码" />
          </div>
          <div>
            <label class="block text-sm mb-2">新密码</label>
            <input id="new-password" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="输入新密码" />
          </div>
          <div class="flex items-end">
            <button id="change-password-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">修改密码</button>
          </div>
        </div>
        <p id="pwd-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">GitHub 连接</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-2">GitHub Token（repo 权限）</label>
            <input id="gh-token" type="password" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="ghp_xxx" />
          </div>
          <div>
            <label class="block text-sm mb-2">分支</label>
            <input id="gh-branch" type="text" value="main" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
          </div>
        </div>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
          <h2 class="text-xl font-semibold">文章管理</h2>
          <div class="flex flex-wrap gap-2">
            <button id="refresh-post-list-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">刷新列表</button>
            <button id="new-post-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">新建文章</button>
            <a class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]" href="/-/" target="_blank">打开前台</a>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-1">
            <label class="block text-sm mb-2">已发布文章（可直接编辑）</label>
            <select id="post-select" size="14" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2 text-sm"></select>
            <button id="load-selected-post-btn" class="mt-3 w-full rounded border border-[var(--button-border-color)] px-3 py-2 hover:bg-[var(--button-hover-color)]">编辑所选文章</button>
          </div>

          <div class="lg:col-span-2 space-y-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">语言</label>
                <select id="post-lang" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2">
                  <option value="zh-cn">中文（zh-cn）</option>
                  <option value="en">English（en）</option>
                </select>
              </div>
              <div>
                <label class="block text-sm mb-1">slug（可留空自动生成）</label>
                <input id="post-slug" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="block text-sm mb-1">标题</label>
              <input id="post-title" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
            </div>

            <div>
              <label class="block text-sm mb-1">正文 Markdown</label>
              <textarea id="post-content" class="w-full min-h-[280px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="在这里写文章内容"></textarea>
            </div>

            <details class="rounded border border-[var(--button-border-color)] p-3">
              <summary class="cursor-pointer text-sm">更多设置（可选）</summary>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
                <div>
                  <label class="block text-sm mb-1">发布日期</label>
                  <input id="post-date" type="datetime-local" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm mb-1">简介</label>
                  <input id="post-desc" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm mb-1">封面路径</label>
                  <input id="post-cover" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="例如：./assets/cover.jpg" />
                </div>
                <div>
                  <label class="block text-sm mb-1">分类</label>
                  <input id="post-category" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="例如：技术" />
                </div>
              </div>
            </details>

            <div class="flex flex-wrap gap-2 items-center">
              <input id="post-files" type="file" multiple accept="image/*,video/*,.pdf,application/pdf" class="hidden" />
              <label for="post-files" class="cursor-pointer rounded border border-[var(--button-border-color)] px-3 py-1.5 text-sm font-medium text-[var(--text-color)] hover:bg-[var(--button-hover-color)]">选择文件</label>
              <span id="post-files-count" class="text-sm text-[var(--text-color)]/70">未选择文件</span>
              <button id="upload-files-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">上传资源</button>
              <button id="insert-iframe-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">插入 iframe</button>
            </div>

            <div class="flex flex-wrap gap-2">
              <button id="publish-post-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">保存文章</button>
              <button id="delete-post-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">删除当前语言</button>
              <button id="delete-post-all-btn" class="rounded border border-[var(--button-border-color)] px-4 py-2 hover:bg-[var(--button-hover-color)]">删除整个博客目录</button>
            </div>
          </div>
        </div>

        <p id="post-msg" class="text-sm mt-3 text-[var(--text-color)]/70"></p>
      </div>

      <div class="rounded-lg border border-[var(--button-border-color)] p-5">
        <h2 class="text-xl font-semibold mb-4">站点内容设置</h2>

        <div class="space-y-4">
          <div class="rounded border border-[var(--button-border-color)] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
              <div class="text-sm font-semibold">About（Markdown）</div>
              <div class="flex flex-wrap items-center gap-2">
                <select id="about-lang" class="rounded border border-[var(--button-border-color)] bg-transparent px-3 py-1.5 text-sm">
                  <option value="zh-cn">中文（zh-cn）</option>
                  <option value="en">English（en）</option>
                </select>
                <button id="load-about-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">加载</button>
                <button id="save-about-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">保存</button>
              </div>
            </div>
            <textarea id="about-content" class="w-full min-h-[180px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="About Markdown 内容"></textarea>
            <p id="about-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
          </div>

          <div class="rounded border border-[var(--button-border-color)] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
              <div class="text-sm font-semibold">友链（JSON）</div>
              <div class="flex flex-wrap items-center gap-2">
                <button id="load-friends-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">加载</button>
                <button id="save-friends-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">保存</button>
              </div>
            </div>
            <textarea id="friends-content" class="w-full min-h-[180px] rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder='请输入 JSON 数组，例如：[{"name":"GitHub","avatar":"...","url":"...","description":"..."}]'></textarea>
            <p id="friends-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
          </div>

          <div class="rounded border border-[var(--button-border-color)] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
              <div class="text-sm font-semibold">右上角联系方式</div>
              <div class="flex flex-wrap items-center gap-2">
                <button id="load-header-contact-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">加载</button>
                <button id="save-header-contact-btn" class="rounded border border-[var(--button-border-color)] px-3 py-1.5 hover:bg-[var(--button-hover-color)]">保存</button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="header-github" type="text" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="GitHub 首页链接：https://github.com/your-name" />
              <input id="header-email" type="email" class="w-full rounded border border-[var(--button-border-color)] bg-transparent px-3 py-2" placeholder="邮箱地址：you@example.com" />
            </div>
            <p id="header-contact-msg" class="text-sm mt-2 text-[var(--text-color)]/70"></p>
          </div>
        </div>
      </div>
    </section>
  </div>
</MainPageLayout>

<script>
  import {
    AdminService,
    buildFriendLinksTs,
    buildHeaderContactTs,
    buildPostMarkdown,
    decodeFileContent,
    getNowDateTimeLocal,
    normalizeSlug,
    parseFriendLinksFromTs,
    parseHeaderContactFromTs,
    toIsoDateTime
  } from "@/utils/admin-service";

  const SESSION_KEY = "cmchen_admin_ok";
  const ADMIN_GH_TOKEN_KEY = "cmchen_admin_gh_token";
  const ADMIN_GH_BRANCH_KEY = "cmchen_admin_gh_branch";
  const REPO_OWNER = "shi-tou1234";
  const REPO_NAME = "-";
  const ADMIN_SECURITY_PATH = "public/admin-security.json";
  const ADMIN_SECURITY_URL = `${window.location.origin}/-/admin-security.json`;
  const HEADER_CONTACT_PATH = "src/data/header-contact.ts";

  const loginSection = document.getElementById("login-section");
  const adminPanel = document.getElementById("admin-panel");
  const loginMsg = document.getElementById("login-msg");

  const adminService = new AdminService({
    repoOwner: REPO_OWNER,
    repoName: REPO_NAME,
    securityPath: ADMIN_SECURITY_PATH,
    securityUrl: ADMIN_SECURITY_URL
  });

  function setMsg(el, message, isError = false) {
    if (!el) return;
    el.textContent = message;
    el.style.color = isError ? "#dc2626" : "";
  }

  function unlockPanel() {
    loginSection?.classList.add("hidden");
    adminPanel?.classList.remove("hidden");
    sessionStorage.setItem(SESSION_KEY, "1");
  }

  function getToken() {
    return (document.getElementById("gh-token")?.value || "").trim();
  }

  function getBranch() {
    return (document.getElementById("gh-branch")?.value || "main").trim();
  }

  function loadGitHubDraft() {
    const tokenInput = document.getElementById("gh-token");
    const branchInput = document.getElementById("gh-branch");
    const savedToken = localStorage.getItem(ADMIN_GH_TOKEN_KEY) || "";
    const savedBranch = localStorage.getItem(ADMIN_GH_BRANCH_KEY) || "main";
    if (tokenInput && savedToken) tokenInput.value = savedToken;
    if (branchInput && savedBranch) branchInput.value = savedBranch;
  }

  function saveGitHubDraft() {
    const token = getToken();
    const branch = getBranch();
    localStorage.setItem(ADMIN_GH_TOKEN_KEY, token);
    localStorage.setItem(ADMIN_GH_BRANCH_KEY, branch || "main");
  }

  async function verifyPassword(password) {
    return adminService.verifyPassword(password);
  }

  async function loadSecurityConfig() {
    await adminService.loadSecurityConfig();
  }

  async function githubRequest(path, token, options = {}) {
    return adminService.githubRequest(path, token, options);
  }

  async function getFileMeta(repoPath, token, branch) {
    return adminService.getFileMeta(repoPath, token, branch);
  }

  async function upsertFile(repoPath, content, message, token, branch) {
    return adminService.upsertFile(repoPath, content, message, token, branch);
  }

  async function fileToBase64(file) {
    const arrayBuffer = await file.arrayBuffer();
    const bytes = new Uint8Array(arrayBuffer);
    let binary = "";
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }

  async function uploadBlogAssetFile({ slug, lang, file, token, branch }) {
    const safeName = file.name.replace(/\s+/g, "-");
    const path = `src/content/blog/${slug}/assets/${safeName}`;
    const b64 = await fileToBase64(file);
    const meta = await getFileMeta(path, token, branch);

    await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(path).replace(/%2F/g, "/")}`, token, {
      method: "PUT",
      body: JSON.stringify({
        message: `upload: ${safeName} for ${slug} (${lang})`,
        content: b64,
        branch,
        ...(meta?.sha ? { sha: meta.sha } : {})
      })
    });

    return { name: safeName, type: file.type || "application/octet-stream" };
  }

  async function renderPdfPagesToImages(file) {
    const pdfjsLib = await import("pdfjs-dist");
    const workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.624/build/pdf.worker.min.mjs";
    pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc;

    const pdfData = new Uint8Array(await file.arrayBuffer());
    const loadingTask = pdfjsLib.getDocument({ data: pdfData });
    const pdfDoc = await loadingTask.promise;

    const baseName = file.name.replace(/\.pdf$/i, "").replace(/\s+/g, "-");
    const generatedFiles = [];

    for (let pageNo = 1; pageNo <= pdfDoc.numPages; pageNo++) {
      const page = await pdfDoc.getPage(pageNo);
      const viewport = page.getViewport({ scale: 1.8 });
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      if (!context) throw new Error("PDF 渲染失败：无法创建画布上下文");

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      context.fillStyle = "#ffffff";
      context.fillRect(0, 0, canvas.width, canvas.height);

      await page.render({
        canvasContext: context,
        viewport,
        background: "#ffffff",
        annotationMode: pdfjsLib.AnnotationMode.ENABLE,
        renderInteractiveForms: true
      }).promise;

      const blob = await new Promise((resolve, reject) => {
        canvas.toBlob((result) => {
          if (result) resolve(result);
          else reject(new Error("PDF 转图片失败"));
        }, "image/png");
      });

      const fileName = `${baseName}-p${String(pageNo).padStart(2, "0")}.png`;
      generatedFiles.push(new File([blob], fileName, { type: "image/png" }));
    }

    return generatedFiles;
  }

  async function deleteFile(repoPath, message, token, branch) {
    return adminService.deleteFile(repoPath, message, token, branch);
  }

  async function listFilesByPrefix(prefix, token, branch) {
    return adminService.listFilesByPrefix(prefix, token, branch);
  }

  async function listBlogMarkdownEntries(token, branch) {
    return adminService.listBlogMarkdownEntries(token, branch);
  }

  if (sessionStorage.getItem(SESSION_KEY) === "1") {
    unlockPanel();
  }

  loadGitHubDraft();
  document.getElementById("gh-token")?.addEventListener("change", saveGitHubDraft);
  document.getElementById("gh-branch")?.addEventListener("change", saveGitHubDraft);

  loadSecurityConfig();

  if (sessionStorage.getItem(SESSION_KEY) === "1") {
    loadPostList().catch((error) => {
      setMsg(document.getElementById("post-msg"), String(error), true);
    });
  }

  document.getElementById("login-btn")?.addEventListener("click", async () => {
    const pwd = document.getElementById("admin-password")?.value || "";
    const passed = await verifyPassword(pwd);
    if (passed) {
      setMsg(loginMsg, "登录成功");
      unlockPanel();
      loadPostList().catch((error) => {
        setMsg(document.getElementById("post-msg"), String(error), true);
      });
    } else {
      setMsg(loginMsg, "密码错误", true);
    }
  });

  document.getElementById("change-password-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("pwd-msg");
    const oldPwd = document.getElementById("old-password")?.value || "";
    const newPwd = document.getElementById("new-password")?.value || "";
    const token = getToken();
    const branch = getBranch();

    if (!token) {
      setMsg(msgEl, "请先填写 GitHub Token", true);
      return;
    }

    await adminService.changePassword({
      oldPassword: oldPwd,
      newPassword: newPwd,
      token,
      branch
    });

    setMsg(msgEl, "密码修改成功，已全站生效（跨设备统一）");
    const oldInput = document.getElementById("old-password");
    const newInput = document.getElementById("new-password");
    if (oldInput) oldInput.value = "";
    if (newInput) newInput.value = "";
  });

  function initPostDateDefault() {
    const input = document.getElementById("post-date");
    if (input && !input.value) {
      input.value = getNowDateTimeLocal();
    }
  }

  function toDateTimeLocalValue(isoLikeValue) {
    if (!isoLikeValue) return "";
    const date = new Date(isoLikeValue);
    if (Number.isNaN(date.getTime())) return "";
    const pad = (n) => String(n).padStart(2, "0");
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function parsePostMarkdown(markdown) {
    const matched = markdown.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);
    if (!matched) {
      return {
        frontmatter: {},
        content: markdown || ""
      };
    }

    const rawFrontmatter = matched[1] || "";
    const bodyContent = matched[2] || "";
    const frontmatter = {};
    rawFrontmatter.split("\n").forEach((line) => {
      const idx = line.indexOf(":");
      if (idx <= 0) return;
      const key = line.slice(0, idx).trim();
      const value = line.slice(idx + 1).trim();
      frontmatter[key] = value;
    });

    return { frontmatter, content: bodyContent };
  }

  function clearPostEditor() {
    const titleInput = document.getElementById("post-title");
    const slugInput = document.getElementById("post-slug");
    const langInput = document.getElementById("post-lang");
    const dateInput = document.getElementById("post-date");
    const descInput = document.getElementById("post-desc");
    const coverInput = document.getElementById("post-cover");
    const categoryInput = document.getElementById("post-category");
    const contentInput = document.getElementById("post-content");

    if (titleInput) titleInput.value = "";
    if (slugInput) slugInput.value = "";
    if (langInput) langInput.value = "zh-cn";
    if (dateInput) dateInput.value = getNowDateTimeLocal();
    if (descInput) descInput.value = "";
    if (coverInput) coverInput.value = "";
    if (categoryInput) categoryInput.value = "";
    if (contentInput) contentInput.value = "";
  }

  function getSelectedPostSlug() {
    const selectEl = document.getElementById("post-select");
    const selectedPath = selectEl?.value || "";
    if (!selectedPath) return "";
    const matched = selectedPath.match(/^src\/content\/blog\/(.+)\/(zh-cn|en)\.md$/);
    return matched?.[1] || "";
  }

  function ensurePostSlug() {
    const slugInput = document.getElementById("post-slug");
    const title = (document.getElementById("post-title")?.value || "").trim();
    const currentSlug = normalizeSlug(slugInput?.value || "");
    if (currentSlug) {
      if (slugInput) slugInput.value = currentSlug;
      return currentSlug;
    }

    const selectedSlug = normalizeSlug(getSelectedPostSlug());
    if (selectedSlug) {
      if (slugInput) slugInput.value = selectedSlug;
      return selectedSlug;
    }

    const titleSlug = normalizeSlug(title);
    const fallbackSlug = titleSlug || `post-${Date.now()}`;
    if (slugInput) slugInput.value = fallbackSlug;
    return fallbackSlug;
  }

  async function loadPostList() {
    const msgEl = document.getElementById("post-msg");
    const selectEl = document.getElementById("post-select");
    const token = getToken();
    const branch = getBranch();

    if (!token) {
      if (selectEl) {
        selectEl.innerHTML = "";
      }
      setMsg(msgEl, "请先填写 GitHub Token 后再加载文章列表", true);
      return;
    }

    setMsg(msgEl, "加载文章列表中...");
    saveGitHubDraft();
    const entries = await listBlogMarkdownEntries(token, branch);

    if (selectEl) {
      selectEl.innerHTML = "";
      if (entries.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "暂无文章";
        selectEl.appendChild(option);
      } else {
        entries.forEach((entry) => {
          const option = document.createElement("option");
          option.value = entry.path;
          option.textContent = `${entry.slug} (${entry.lang})`;
          selectEl.appendChild(option);
        });
      }
    }

    setMsg(msgEl, `已加载 ${entries.length} 篇文章`);
  }

  async function loadSelectedPostToEditor() {
    const msgEl = document.getElementById("post-msg");
    const selectEl = document.getElementById("post-select");
    const selectedPath = selectEl?.value || "";
    const token = getToken();
    const branch = getBranch();

    if (!token) throw new Error("请先填写 GitHub Token");
    if (!selectedPath) throw new Error("请先选择文章");

    const meta = await getFileMeta(selectedPath, token, branch);
    if (!meta?.content) throw new Error("文章内容为空或不存在");

    const rawMarkdown = decodeFileContent(meta.content);
    const { frontmatter, content } = parsePostMarkdown(rawMarkdown);

    const slugMatched = selectedPath.match(/^src\/content\/blog\/(.+)\/(zh-cn|en)\.md$/);
    const slug = slugMatched?.[1] || "";
    const lang = slugMatched?.[2] || "zh-cn";

    const titleInput = document.getElementById("post-title");
    const slugInput = document.getElementById("post-slug");
    const langInput = document.getElementById("post-lang");
    const dateInput = document.getElementById("post-date");
    const descInput = document.getElementById("post-desc");
    const coverInput = document.getElementById("post-cover");
    const categoryInput = document.getElementById("post-category");
    const contentInput = document.getElementById("post-content");

    if (titleInput) titleInput.value = frontmatter.title || "";
    if (slugInput) slugInput.value = slug;
    if (langInput) langInput.value = lang;
    if (dateInput) dateInput.value = toDateTimeLocalValue(frontmatter.pubDate || "") || getNowDateTimeLocal();
    if (descInput) descInput.value = frontmatter.description || "";
    if (coverInput) coverInput.value = frontmatter.image || "";
    if (categoryInput) categoryInput.value = frontmatter.category || "";
    if (contentInput) contentInput.value = (content || "").trim();

    setMsg(msgEl, `已载入：${slug} (${lang})`);
  }

  initPostDateDefault();
  document.getElementById("post-files")?.addEventListener("change", () => {
    const files = document.getElementById("post-files")?.files;
    const countEl = document.getElementById("post-files-count");
    if (!countEl) return;
    const count = files?.length || 0;
    countEl.textContent = count > 0 ? `已选择 ${count} 个文件` : "未选择文件";
  });

  document.getElementById("refresh-post-list-btn")?.addEventListener("click", loadPostList);
  document.getElementById("load-selected-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      await loadSelectedPostToEditor();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });
  document.getElementById("new-post-btn")?.addEventListener("click", () => {
    clearPostEditor();
    setMsg(document.getElementById("post-msg"), "已切换到新建文章模式");
  });
  document.getElementById("post-select")?.addEventListener("dblclick", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      await loadSelectedPostToEditor();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("insert-iframe-btn")?.addEventListener("click", () => {
    const textarea = document.getElementById("post-content");
    const iframeTpl = `\n<iframe src=\"https://www.youtube.com/embed/VIDEO_ID\" title=\"Video\" frameborder=\"0\" allowfullscreen></iframe>\n`;
    textarea.value = `${textarea.value || ""}${iframeTpl}`;
  });

  document.getElementById("upload-files-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const slug = ensurePostSlug();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const files = document.getElementById("post-files")?.files;

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!files || files.length === 0) throw new Error("请先选择文件");

      setMsg(msgEl, `上传中...（${files.length} 个文件）`);

      const uploaded = [];
      for (const file of files) {
        const isPdf = file.type === "application/pdf" || /\.pdf$/i.test(file.name);

        if (isPdf) {
          setMsg(msgEl, `正在转换 PDF：${file.name}`);
          const imageFiles = await renderPdfPagesToImages(file);
          for (const imageFile of imageFiles) {
            const result = await uploadBlogAssetFile({ slug, lang, file: imageFile, token, branch });
            uploaded.push({ ...result, fromPdf: true });
          }
          continue;
        }

        const result = await uploadBlogAssetFile({ slug, lang, file, token, branch });
        uploaded.push({ ...result, fromPdf: false });
      }

      const textarea = document.getElementById("post-content");
      const coverInput = document.getElementById("post-cover");
      const firstImage = uploaded.find((f) => f.type.startsWith("image/") && !f.fromPdf);
      const coverWasEmpty = !!(coverInput && !coverInput.value.trim());
      const coverNameToSkip = coverWasEmpty && firstImage ? firstImage.name : "";

      const snippets = uploaded.filter((f) => f.name !== coverNameToSkip).map((f) => {
        if (f.type.startsWith("image/")) return `![${f.name}](./assets/${f.name})`;
        if (f.type.startsWith("video/")) return `<video controls src=\"./assets/${f.name}\"></video>`;
        return `[${f.name}](./assets/${f.name})`;
      }).join("\n\n");

      if (coverInput && !coverInput.value.trim() && firstImage) {
        coverInput.value = `./assets/${firstImage.name}`;
      }

      if (snippets) {
        textarea.value = `${textarea.value || ""}\n\n${snippets}\n`;
      }
      const fileInput = document.getElementById("post-files");
      if (fileInput) fileInput.value = "";
      const countEl = document.getElementById("post-files-count");
      if (countEl) countEl.textContent = "未选择文件";
      const coverMsg = coverNameToSkip ? `，已将 ${coverNameToSkip} 设为封面且不插入正文` : "";
      setMsg(msgEl, `上传成功：${uploaded.length} 个文件（目录：${slug}/assets）${coverMsg}`);
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("publish-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const title = (document.getElementById("post-title")?.value || "").trim();
      const dateInput = (document.getElementById("post-date")?.value || "").trim();
      const date = toIsoDateTime(dateInput) || new Date().toISOString();
      const description = (document.getElementById("post-desc")?.value || "").trim();
      const image = (document.getElementById("post-cover")?.value || "").trim();
      const category = (document.getElementById("post-category")?.value || "").trim();
      const content = document.getElementById("post-content")?.value || "";
      const inputSlug = ensurePostSlug();
      const fallbackSlug = normalizeSlug(title);
      const slug = inputSlug || fallbackSlug || `post-${Date.now()}`;

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!title) throw new Error("请填写标题");

      const slugInput = document.getElementById("post-slug");
      if (slugInput && !slugInput.value.trim()) {
        slugInput.value = slug;
      }

      const markdown = buildPostMarkdown({
        title,
        date,
        description,
        image,
        category,
        slugId: slug,
        content
      });

      const path = `src/content/blog/${slug}/${lang}.md`;
      setMsg(msgEl, "发布中...");
      saveGitHubDraft();
      await upsertFile(path, markdown, `post: update ${slug}/${lang}`, token, branch);
      setMsg(msgEl, `发布成功：${path}`);
      await loadPostList();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("delete-post-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("post-lang")?.value || "zh-cn").trim();
      const slug = ensurePostSlug();

      if (!token) throw new Error("请先填写 GitHub Token");

      const path = `src/content/blog/${slug}/${lang}.md`;
      const confirmed = window.confirm(`确认删除文章文件？\n${path}`);
      if (!confirmed) return;

      setMsg(msgEl, "删除中...");
      saveGitHubDraft();
      const deleted = await deleteFile(path, `post: delete ${slug}/${lang}`, token, branch);

      if (!deleted) {
        throw new Error(`未找到文件：${path}`);
      }

      setMsg(msgEl, `删除成功：${path}`);
      await loadPostList();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("delete-post-all-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("post-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const slug = ensurePostSlug();

      if (!token) throw new Error("请先填写 GitHub Token");

      const prefix = `src/content/blog/${slug}/`;
      const confirmed = window.confirm(`确认删除整个博客目录？\n${prefix}\n\n这会删除该目录下所有语言文件和资源文件。`);
      if (!confirmed) return;

      setMsg(msgEl, "扫描目录中...");
      const files = await listFilesByPrefix(prefix, token, branch);
      if (files.length === 0) {
        throw new Error(`目录为空或不存在：${prefix}`);
      }

      setMsg(msgEl, `删除中...（共 ${files.length} 个文件）`);
      saveGitHubDraft();
      for (const file of files) {
        await deleteFile(file, `post: delete ${slug} directory`, token, branch);
      }

      setMsg(msgEl, `删除成功：${prefix}（已删除 ${files.length} 个文件）`);
      await loadPostList();
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-about-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("about-lang")?.value || "zh-cn").trim();
      if (!token) throw new Error("请先填写 GitHub Token");

      const path = `src/content/spec/about/${lang}.md`;
      const meta = await getFileMeta(path, token, branch);
      const content = decodeFileContent(meta?.content || "");
      document.getElementById("about-content").value = content;
      setMsg(msgEl, "加载成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-about-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("about-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const lang = (document.getElementById("about-lang")?.value || "zh-cn").trim();
      const content = document.getElementById("about-content")?.value || "";
      if (!token) throw new Error("请先填写 GitHub Token");

      const path = `src/content/spec/about/${lang}.md`;
      await upsertFile(path, content, `about: update ${lang}`, token, branch);
      setMsg(msgEl, "保存成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-friends-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("friends-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("请先填写 GitHub Token");

      const path = "src/data/friend-links.ts";
      const meta = await getFileMeta(path, token, branch);
      const content = decodeFileContent(meta?.content || "");
      const links = parseFriendLinksFromTs(content);
      document.getElementById("friends-content").value = JSON.stringify(links, null, 2);
      setMsg(msgEl, "友链加载成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-friends-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("friends-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const raw = document.getElementById("friends-content")?.value || "[]";
      if (!token) throw new Error("请先填写 GitHub Token");

      const links = JSON.parse(raw);
      if (!Array.isArray(links)) throw new Error("友链内容必须是 JSON 数组");

      links.forEach((item, index) => {
        if (
          typeof item?.name !== "string" ||
          typeof item?.avatar !== "string" ||
          typeof item?.url !== "string" ||
          typeof item?.description !== "string"
        ) {
          throw new Error(`第 ${index + 1} 条友链格式不正确`);
        }
      });

      const path = "src/data/friend-links.ts";
      const content = buildFriendLinksTs(links);
      await upsertFile(path, content, "friends: update links", token, branch);
      setMsg(msgEl, "友链保存成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("load-header-contact-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("header-contact-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      if (!token) throw new Error("请先填写 GitHub Token");

      const meta = await getFileMeta(HEADER_CONTACT_PATH, token, branch);
      const content = decodeFileContent(meta?.content || "");
      const contact = parseHeaderContactFromTs(content);

      document.getElementById("header-github").value = contact.githubUrl || "";
      document.getElementById("header-email").value = contact.email || "";
      setMsg(msgEl, "联系方式加载成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });

  document.getElementById("save-header-contact-btn")?.addEventListener("click", async () => {
    const msgEl = document.getElementById("header-contact-msg");
    try {
      const token = getToken();
      const branch = getBranch();
      const githubUrl = (document.getElementById("header-github")?.value || "").trim();
      const email = (document.getElementById("header-email")?.value || "").trim();

      if (!token) throw new Error("请先填写 GitHub Token");
      if (!githubUrl) throw new Error("请填写 GitHub 首页链接");
      if (!email) throw new Error("请填写邮箱地址");

      const content = buildHeaderContactTs({ githubUrl, email });
      await upsertFile(HEADER_CONTACT_PATH, content, "header: update contact links", token, branch);
      setMsg(msgEl, "联系方式保存成功");
    } catch (error) {
      setMsg(msgEl, String(error), true);
    }
  });
</script>
