---
import '@fontsource-variable/jetbrains-mono'
import '@fontsource-variable/jetbrains-mono/wght-italic.css'
import '@styles/markdown.css'

interface Props {
  class?: string
}
const className = Astro.props.class
---
<div data-pagefind-body class=`markdown-content ${className}`>
    <slot/>
</div>

<script>
  function bindImageSkeleton(img) {
    const markLoaded = () => {
      img.classList.remove('markdown-image-loading');
      img.classList.add('markdown-image-loaded');
    };

    if (img.complete && img.naturalWidth > 0) {
      markLoaded();
      return;
    }

    img.classList.add('markdown-image-loading');
    img.classList.remove('markdown-image-loaded');
    img.addEventListener('load', markLoaded, { once: true });
    img.addEventListener('error', markLoaded, { once: true });
  }

  function stabilizeMarkdownImages() {
    const images = document.querySelectorAll('.markdown-content img');
    images.forEach((img) => {
      img.setAttribute('loading', 'eager');
      img.setAttribute('decoding', 'sync');
      img.setAttribute('fetchpriority', 'high');
      img.style.imageRendering = 'auto';
      bindImageSkeleton(img);
    });
  }

  function setupSpoilers() {
    const spoilers = document.querySelectorAll('.spoiler');
    
    spoilers.forEach(el => {
      let timeoutId = null;
      let clickTime = 0;

      el.addEventListener('click', () => {
        el.classList.add('revealed');
        clickTime = Date.now();

        if (timeoutId) clearTimeout(timeoutId);

        const isMobile = window.innerWidth < 776;

        if (!isMobile) {
          // --- 桌面端逻辑：保持原样，3秒后自动模糊 ---
          timeoutId = setTimeout(() => {
            el.classList.remove('revealed');
          }, 3000);
        } else {
          // --- 移动端逻辑 (< 776px) ---
          // 只有满足两个条件：1. 发生滚动 2. 距离点击已过3秒
          const handleScroll = () => {
            const timeElapsed = Date.now() - clickTime;
            
            if (timeElapsed >= 3000) {
              el.classList.remove('revealed');
              window.removeEventListener('scroll', handleScroll);
            }
          };

          window.addEventListener('scroll', handleScroll, { passive: true });
        }
      });
    });
  }

  stabilizeMarkdownImages();
  setupSpoilers();
  document.addEventListener('astro:page-load', stabilizeMarkdownImages);
  document.addEventListener('astro:page-load', setupSpoilers);
</script>

<style is:global>
  .markdown-content img {
    transition: opacity .25s ease;
  }

  .markdown-content img.markdown-image-loading {
    opacity: 0;
    background: linear-gradient(90deg,
      var(--button-hover-color) 25%,
      color-mix(in srgb, var(--button-hover-color) 70%, white) 37%,
      var(--button-hover-color) 63%
    );
    background-size: 300% 100%;
    animation: markdown-image-skeleton 1.2s ease-in-out infinite;
  }

  .markdown-content img.markdown-image-loaded {
    opacity: 1;
    animation: none;
  }

  @keyframes markdown-image-skeleton {
    0% { background-position: 100% 50%; }
    100% { background-position: 0 50%; }
  }

  .code-block-wrapper {
    position: relative !important;
    width: 100%;
  }

  pre {
    margin-top: 0 !important;
    overflow-x: auto;
  }
  .copy-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 20;
    padding: 6px;
    background: rgba(40, 44, 52, 0.8); 
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    cursor: pointer;
    color: #ccc;
    
    opacity: 0;
    transition: all 0.2s ease-in-out;
    
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .code-block-wrapper:hover .copy-btn {
    opacity: 1;
  }

  @media (hover: none) {
    .copy-btn {
      opacity: 1;
    }
  }

  .copy-btn .icon-check {
    display: none; 
  }

  .copy-btn.copied .icon-copy {
    display: none; 
  }

  .copy-btn.copied .icon-check {
    display: block; 
    color: #4caf50;
  }

  .copy-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }
</style>

<script>
  const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
  const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

  function createCopyButtons() {
    const blocks = document.querySelectorAll("pre");

    blocks.forEach((block) => {
      if (block.parentElement.classList.contains("code-block-wrapper")) return;

      const wrapper = document.createElement("div");
      wrapper.className = "code-block-wrapper";

      block.parentNode.insertBefore(wrapper, block);
      wrapper.appendChild(block);

      const button = document.createElement("button");
      button.className = "copy-btn";
      button.innerHTML = `<span class="icon-copy">${copyIcon}</span><span class="icon-check">${checkIcon}</span>`;
      
      wrapper.appendChild(button);

      button.addEventListener("click", async () => {
        const code = block.querySelector("code");
        const text = code ? code.innerText : block.innerText;
        await navigator.clipboard.writeText(text);

        button.classList.add("copied");
        setTimeout(() => button.classList.remove("copied"), 2000);
      });
    });
  }


  createCopyButtons();
  document.addEventListener("astro:page-load", createCopyButtons);
</script>