---
interface Props {
  id: string;
}

const { id } = Astro.props;
---

<div id={id} class="pointer-events-none fixed inset-0 z-0"></div>

<script define:vars={{ containerId: id }}>
  import { tsParticles } from "@tsparticles/engine";
  import { loadSlim } from "@tsparticles/slim";

  function hasTarget() {
    return Boolean(document.getElementById(containerId));
  }

  function getParticleColor() {
    const computed = getComputedStyle(document.documentElement);
    const linkColor = computed.getPropertyValue("--link-color").trim();
    if (linkColor) return linkColor;
    const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
    return currentTheme === "dark" ? "#cbd5e1" : "#0ea5e9";
  }

  async function mountParticles() {
    if (!hasTarget()) return;

    await loadSlim(tsParticles);

    const mounted = tsParticles.dom().find((item) => item.id === containerId);
    if (mounted) {
      await mounted.destroy();
    }

    const color = getParticleColor();

    await tsParticles.load({
      id: containerId,
      options: {
        fullScreen: { enable: false },
        background: { color: "transparent" },
        fpsLimit: 60,
        detectRetina: true,
        particles: {
          number: { value: 110, density: { enable: true, area: 1000 } },
          color: { value: color },
          opacity: {
            value: { min: 0.12, max: 0.35 },
            animation: { enable: true, speed: 0.9, sync: false },
          },
          size: {
            value: { min: 1, max: 2.8 },
            animation: { enable: true, speed: 2, sync: false, minimumValue: 0.7 },
          },
          move: {
            enable: true,
            speed: 1.7,
            direction: "none",
            random: true,
            straight: false,
            outModes: { default: "bounce" },
          },
          links: {
            enable: false,
          },
        },
        interactivity: {
          detectsOn: "canvas",
          events: {
            onHover: { enable: true, mode: "repulse" },
            onClick: { enable: true, mode: "push" },
            resize: { enable: true },
          },
          modes: {
            repulse: { distance: 90, duration: 0.35 },
            push: { quantity: 2 },
          },
        },
        pauseOnBlur: false,
        pauseOnOutsideViewport: false,
      },
    });
  }

  function setupThemeWatcher() {
    if (!hasTarget()) return;

    const observerKey = `__particleObserver_${containerId}`;
    const oldObserver = window[observerKey];
    if (oldObserver) oldObserver.disconnect();

    const observer = new MutationObserver(() => {
      mountParticles();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });

    window[observerKey] = observer;
  }

  function initParticles() {
    if (!hasTarget()) return;
    mountParticles();
    setupThemeWatcher();
  }

  document.addEventListener("astro:page-load", initParticles);
  document.addEventListener("astro:after-swap", initParticles);
</script>
