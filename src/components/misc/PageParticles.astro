---
interface Props {
  id: string;
}

const { id } = Astro.props;
---

<div id={id} data-page-particles="1" class="pointer-events-none fixed inset-0 z-0"></div>

<script>
  import { tsParticles } from "@tsparticles/engine";
  import { loadSlim } from "@tsparticles/slim";

  async function mountParticlesById(containerId) {
    const target = document.getElementById(containerId);
    if (!target) return;

    await loadSlim(tsParticles);

    const mounted = tsParticles.dom().find((item) => item.id === containerId);
    if (mounted) {
      await mounted.destroy();
    }

    const computed = getComputedStyle(document.documentElement);
    const linkColor = computed.getPropertyValue("--link-color").trim();
    const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
    const fallbackColor = currentTheme === "dark" ? "#cbd5e1" : "#0ea5e9";
    const color = linkColor || fallbackColor;

    await tsParticles.load({
      id: containerId,
      options: {
        fullScreen: { enable: false },
        background: { color: "transparent" },
        fpsLimit: 60,
        detectRetina: true,
        particles: {
          number: { value: 110, density: { enable: true, area: 1000 } },
          color: { value: color },
          opacity: {
            value: { min: 0.12, max: 0.35 },
            animation: { enable: true, speed: 0.9, sync: false },
          },
          size: {
            value: { min: 1, max: 2.8 },
            animation: { enable: true, speed: 2, sync: false, minimumValue: 0.7 },
          },
          move: {
            enable: true,
            speed: 1.7,
            direction: "none",
            random: true,
            straight: false,
            outModes: { default: "bounce" },
          },
          links: {
            enable: false,
          },
        },
        interactivity: {
          detectsOn: "canvas",
          events: {
            onHover: { enable: true, mode: "repulse" },
            onClick: { enable: true, mode: "push" },
            resize: { enable: true },
          },
          modes: {
            repulse: { distance: 90, duration: 0.35 },
            push: { quantity: 2 },
          },
        },
        pauseOnBlur: false,
        pauseOnOutsideViewport: false,
      },
    });
  }

  function getParticleTargets() {
    return Array.from(document.querySelectorAll("[data-page-particles='1']"));
  }

  function mountAllParticles() {
    const targets = getParticleTargets();
    targets.forEach((target) => {
      const id = target.getAttribute("id");
      if (!id) return;
      mountParticlesById(id);
    });
  }

  function setupThemeWatcher() {
    const observerKey = "__pageParticlesThemeObserver";
    const oldObserver = window[observerKey];
    if (oldObserver) oldObserver.disconnect();

    const observer = new MutationObserver(() => {
      mountAllParticles();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });

    window[observerKey] = observer;
  }

  function initParticles() {
    mountAllParticles();
    setupThemeWatcher();
  }

  initParticles();
  document.addEventListener("DOMContentLoaded", initParticles);
  document.addEventListener("astro:page-load", initParticles);
  document.addEventListener("astro:after-swap", initParticles);
</script>
