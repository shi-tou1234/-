---
const className = Astro.props.class;
import { Icon } from "astro-icon/components";
---

<button id="themeToggle" title="切换明暗模式" class={className}>
    <Icon name="material-symbols:dark-mode-outline-rounded" class="moon w-5 h-5"/>
    <Icon name="material-symbols:wb-sunny-outline-rounded" class="sun w-5 h-5"/>
    <Icon name="material-symbols:radio-button-partial-outline" class="system w-5 h-5"/>
</button>

<script is:inline>
if (typeof window !== 'undefined') {
  const THEME_MEDIA_QUERY = '(prefers-color-scheme: dark)';

  function initThemeToggle() {
    const htmlRoot = document.querySelector('html');
    const themeToggle = document.getElementById('themeToggle');

    const getTheme = () => {
      const localStorageTheme = localStorage?.getItem("theme") ?? '';
      if (['dark', 'light', 'system'].includes(localStorageTheme)) {
        return localStorageTheme;
      }
      return 'system';
    };

    const setTheme = (themeSet) => { 
      if (themeSet === 'dark') {
        htmlRoot.setAttribute('data-theme', 'dark');
        htmlRoot.classList.remove('system-theme');
      } else if (themeSet === 'light') {
        htmlRoot.removeAttribute('data-theme');
        htmlRoot.classList.remove('system-theme');
      } else {
        htmlRoot.classList.add('system-theme');
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          htmlRoot.setAttribute('data-theme', 'dark');
        } else {
          htmlRoot.removeAttribute('data-theme');
        }
      }
      window.localStorage.setItem('theme', themeSet);
    };

    // 系统主题变化监听器
    const handleSystemThemeChange = (e) => {
      if (htmlRoot.classList.contains('system-theme')) {
        if (e.matches) {
          htmlRoot.setAttribute('data-theme', 'dark');
        } else {
          htmlRoot.removeAttribute('data-theme');
        }
      }
    };

    const mediaQuery = window.matchMedia(THEME_MEDIA_QUERY);
    const oldSystemThemeChangeHandler = window.__themeSystemThemeChangeHandler;
    if (oldSystemThemeChangeHandler) {
      mediaQuery.removeEventListener('change', oldSystemThemeChangeHandler);
    }
    mediaQuery.addEventListener('change', handleSystemThemeChange);
    window.__themeSystemThemeChangeHandler = handleSystemThemeChange;

    const handleToggleClick = () => {
      const isCurrentlyDark = htmlRoot.getAttribute('data-theme') === 'dark';
      const nextTheme = isCurrentlyDark ? 'light' : 'dark';
      setTheme(nextTheme);
    };

    if (themeToggle) {
      themeToggle.onclick = handleToggleClick;
    }

    setTheme(getTheme());
  }

  document.addEventListener('astro:page-load', initThemeToggle);
  document.addEventListener('astro:after-swap', initThemeToggle);
}
</script>


<style>
    #themeToggle .moon {
        display: none;
    }
    
    #themeToggle .sun {
        display: none;
    }
    
    #themeToggle .system {
        display: none;
    }
    
    #themeToggle .sun {
        display: inline-block;
    }
    
    html[data-theme="dark"] #themeToggle .moon {
        display: inline-block;
    }
    
    html[data-theme="dark"] #themeToggle .sun {
        display: none;
    }
    
    html.system-theme #themeToggle .system {
        display: inline-block;
    }
    
    html.system-theme #themeToggle .sun,
    html.system-theme #themeToggle .moon {
        display: none;
    }
    
</style>