---
import { Icon } from "astro-icon/components";
---

<button id="backTop" title="回到顶部" class="fixed bottom-[8vh] left-[var(--toc-offset-left)] w-12 h-12 rounded-full bg-[--bg-color] cursor-pointer flex items-center justify-center z-[1000] transition-all duration-300 opacity-90 border-0 hover:scale-110 active:scale-90 hover:shadow-[0_4px_15px_rgba(59,130,246,0.4)] hidden">
  <!-- 圆形进度条 -->
  <svg class="absolute top-0 left-0 w-full h-full -rotate-90" viewBox="0 0 48 48">
    <circle id="circle" cx="24" cy="24" r="20" fill="none" stroke="currentColor" stroke-width="2"></circle>
    <circle id="progress-circle" cx="24" cy="24" r="20" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="0 125.6" stroke-linecap="round"></circle>
  </svg>
  <!-- 向上的图标 -->
  <Icon name="fa6-solid:arrow-up" class="relative z-10 text-lg text-[var(--text-color)]" />
</button>

<script is:inline>
function initBackTop() {
  const backTopButton = document.getElementById('backTop');
  const progressCircle = document.getElementById('progress-circle');
  if (!backTopButton || !progressCircle) return;

  const handleScroll = () => {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const documentHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrollPercent = documentHeight > 0 ? Math.min(100, Math.round((scrollTop / documentHeight) * 100)) : 0;

    const circumference = 2 * Math.PI * 20; // 2 * π * r
    const offset = circumference - (scrollPercent / 100) * circumference;
    progressCircle.style.strokeDasharray = `${circumference - offset} ${offset}`;

    if (window.innerWidth >= 1024 && scrollTop > 10) {
      backTopButton.classList.remove('hidden');
    } else {
      backTopButton.classList.add('hidden');
    }
  };

  const scrollToTop = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const oldScrollHandler = window.__backTopScrollHandler;
  const oldResizeHandler = window.__backTopResizeHandler;
  if (oldScrollHandler) {
    window.removeEventListener('scroll', oldScrollHandler);
  }
  if (oldResizeHandler) {
    window.removeEventListener('resize', oldResizeHandler);
  }

  window.addEventListener('scroll', handleScroll, { passive: true });
  window.addEventListener('resize', handleScroll);
  window.__backTopScrollHandler = handleScroll;
  window.__backTopResizeHandler = handleScroll;

  backTopButton.onclick = scrollToTop;
  handleScroll();
}

document.addEventListener('astro:page-load', initBackTop);
document.addEventListener('astro:after-swap', initBackTop);
</script>

<style is:global>
  #backTop {
    box-shadow: 0 2px 10px var(--shadow-color);
  }

  #progress-circle {
    stroke: var(--text-color);
  }

  #circle {
    stroke: var(--button-border-color);
  }
</style>