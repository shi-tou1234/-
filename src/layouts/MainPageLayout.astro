---
import Layout from '@layouts/Layout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import Search from '@components/misc/Search.astro';


interface Props {
  title: string;
  lang: string;
}
const { title, lang } = Astro.props;

---

<Layout title={title} lang={lang}>
  <div class="flex flex-col min-h-screen">
    <div id="global-page-particles" class="pointer-events-none fixed inset-0 z-0"></div>
    <div>
      <Header />
    </div>
    <main class="relative z-10 flex-grow">
      <slot />
    </main>
    <Footer />
    <Search />
  </div>
</Layout>

<script>
  import { tsParticles } from "@tsparticles/engine";
  import { loadSlim } from "@tsparticles/slim";

  const containerId = "global-page-particles";

  function shouldMountParticles() {
    const hasContainer = Boolean(document.getElementById(containerId));
    if (!hasContainer) return false;
    return !window.location.pathname.includes("/admin");
  }

  function isBlogDetailPage() {
    return /\/blog\/.+/.test(window.location.pathname);
  }

  function getParticleColor() {
    const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
    if (currentTheme === "dark") {
      return ["#38bdf8", "#818cf8", "#a78bfa", "#22d3ee"];
    }
    return ["#2563eb", "#a855f7", "#ec4899", "#06b6d4"];
  }

  async function mountParticles() {
    if (!shouldMountParticles()) return;

    await loadSlim(tsParticles);

    const mounted = tsParticles.dom().find((item) => item.id === containerId);
    if (mounted) {
      await mounted.destroy();
    }

    const isBlogPage = isBlogDetailPage();
    const color = getParticleColor();

    await tsParticles.load({
      id: containerId,
      options: {
        fullScreen: { enable: false },
        background: { color: "transparent" },
        fpsLimit: 60,
        detectRetina: true,
        particles: {
          number: { value: isBlogPage ? 95 : 145, density: { enable: true, area: isBlogPage ? 980 : 860 } },
          color: { value: color },
          opacity: {
            value: isBlogPage ? { min: 0.14, max: 0.4 } : { min: 0.28, max: 0.78 },
            animation: { enable: true, speed: 0.9, sync: false },
          },
          size: {
            value: isBlogPage ? { min: 0.8, max: 2.4 } : { min: 1.1, max: 3.9 },
            animation: { enable: true, speed: 1.4, sync: false },
          },
          move: {
            enable: true,
            speed: isBlogPage ? 1.3 : 2.05,
            direction: "none",
            random: true,
            straight: false,
            outModes: { default: "bounce" },
          },
          links: {
            enable: false,
          },
        },
        interactivity: {
          detectsOn: "canvas",
          events: {
            onHover: { enable: true, mode: ["bubble"] },
            onClick: { enable: true, mode: "push" },
            resize: { enable: true },
          },
          modes: {
            bubble: isBlogPage
              ? { distance: 95, size: 2.8, duration: 1.1, opacity: 0.55 }
              : { distance: 130, size: 4.2, duration: 1.8, opacity: 0.82 },
            push: { quantity: isBlogPage ? 1 : 2 },
          },
        },
        pauseOnBlur: false,
        pauseOnOutsideViewport: false,
      },
    });
  }

  function setupThemeWatcher() {
    if (!shouldMountParticles()) return;

    const oldObserver = window.__globalParticleThemeObserver;
    if (oldObserver) oldObserver.disconnect();

    const observer = new MutationObserver(() => {
      mountParticles();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });

    window.__globalParticleThemeObserver = observer;
  }

  function initGlobalParticles() {
    if (!shouldMountParticles()) return;
    mountParticles();
    setupThemeWatcher();
  }

  initGlobalParticles();
  document.addEventListener("astro:page-load", initGlobalParticles);
  document.addEventListener("astro:after-swap", initGlobalParticles);
</script>